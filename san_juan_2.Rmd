---
title: "Rio Grande V2"
author: "Brian"
date: "1/30/2023"
output:
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

# Disclaimer 

*This work is very preliminary as I get back into the coding swing of things. Data wrangling and figure generation will be done via R, but the rest of the project will be done using good ol' microsoft products. This is just an entry point into data crunching and should by no means be considered a final product.*

*Also, I'm not great at this but whatever. I could automate this, but I'll figure that out shortly!*

**Need to update figures & analyze sites for seasonal trends**

# Methodology

SNOTEL data was provided by the NRCS. Data was cleaned by removing outliers that are likely implausible; any year with more than 15 observations missing was removed. Temperatures were adjusted using the Morrisey method for stations identified by Ma et al (2019) due to SNOTEL temperature sensor changes, with the adjustment applied to pre-sensor change data. Daily mean observations were detrended to determine whether values were increasing or decreasing from the entire time series trend. Daily mean temperatures were first averaged by water year, with all water year means then averaged by day of water year. The mean temperature by day for the period of record was averaged. To find the standard deviation, the daily mean temperatures by water year was subtracted from the averaged mean temperature by day for the period of record. All water year means averaged by day of water year were subtracted from the temperature mean. The resulting values were then added together to find the “residual” of the daily mean temperatures by water year. The standard deviation was then computed from those residuals, with trends analyzed by Mann‐Kendall significance test and Theil‐Sen's rate of change. Significant trends are identified with p-values of less than 0.10.

Morrisey Method

The Morrisey Method is taken from [Ma, Fassnacht and Kampf.](https://agupubs.onlinelibrary.wiley.com/doi/epdf/10.1029/2019WR025921). 

In R script: T(adjusted) = 5.3x10^(-7)xT(old)^4+3.72x10^(-5)xT(old)^3-2.16x10^(-3)xT(old)^2-7.32x10^(-2)xT(old)+1.37

**In the Ma et al. spreadsheet, H1 is Morrisey, H2 is Oiler**

# 03/01/2023 update
Analyzing by summer and winter season for each station’s timeseries, using the shifted mean of the time series, then sigmoidal detrending. Standard deviation is taken with the relevant days of the water year.

# 03/06/2023 update
Analyzing by spring and fall season as well....

```{r libraries, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(snotelr)
library(riem)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(dataRetrieval)
library(lubridate)
library(sf)
library(ggthemes)
library(xts)
library(dygraphs)
library(scales)
library(openair)
library(plotly)
library(SciViews)
knitr::opts_chunk$set(message = F, 
                      warning = F,
                      cache = T)
knitr::opts_chunk$set(echo = TRUE)
library(trend)
library(nhdplusTools)
#library(lfstat) No longer supported?
library(ggpubr)
library(kableExtra)

#Stats
library(forcats)
library(stringr)
library(trend)

# COOP/ Did not work- seems to be limited to coastal areas
#library(rnoaa)
```

San Juan Area SNOTEL sites:

Beartown	327 *Original* 4/18/2005

Cascade #2	387 *Morrisey* 6/18/2004

Cumbres Trestle	431 *Oyler -> Morrisey* 6/8/2005

Idarado	538 *Morrisey* 7/12/2004

Lone Cone 	589 *Oyler -> Morrisey* 6/22/2005

Middle Creek	624 *Morrisey* 6/26/2006

Mineral Creek	629 *Oyler ?? -> Morrisey* 6/22/2004

Molas Lake	632 *NSCE-Morrisey, Bias-Original*  10/2/2003

Red Mountain Pass	713 *Morrisey* 8/18/2004

Scotch Creek	739 *Morrisey* 6/15/2004

Slumgullion	762 *Morrisey* 6/26/2006

Spud Mountain	780 *Morrisey* 6/28/2004

Stump Lakes	797 *Morrisey* 7/22/2005

Upper Rio Grande	839 *Oyler -> Morrisey* 5/26/2004 *Why is this in red?

Upper San Juan	840 *Morrisey* 4/7/2004

Vallecito	843 *Morrisey* 7/22/2005

Wolf Creek Summit	874 *Morrisey* 7/12/2004


## Data from thesis research:

```{read in San Juan area SNOTELr,eval=FALSE, include=TRUE}

SNOTEL_san_juan_Area <- snotel_download(site_id = c(327, 387, 431, 538, 589, 624, 629, 632, 713, 739, 762, 780, 797, 839, 840, 843, 874), path = tempdir('../data'), internal = TRUE)

write.csv(SNOTEL_san_juan_Area,"C:/Users/13074/Documents/ESS580/thesis_project/San_Juan_area/data_raw/snotel_san_juans.csv", row.names = FALSE) #write in the raw data

```

# Beartown	327
*Original*

```{r filter Beartown (327) station}

SNOTEL_san_juan_Area <- read.csv("C:/Users/13074/Documents/ESS580/thesis_project/San_Juan_area/data_raw/snotel_san_juans.csv", header = TRUE)

snotel_327 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "327")

```

```{r 327 clean & water year & day }
#str(snotel_327) # check the date, usually a character.  

snotel_327$Date <- as.Date(snotel_327$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_327_clean <- snotel_327 %>% # filter for the timeframe
  filter(Date >= "1983-08-10" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_327_clean <- snotel_327_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 327 plot check }

# Check for outliers

ggplot(snotel_327_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```



```{r 327 trying to clean outliers}



snotel_327_clean <- snotel_327_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_min > -40)

```


```{r 327 temp difference}

ggplot(snotel_327_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 327 cull selection}

# filtering for temperature anomalies
snotel_327_cull_count <- snotel_327_clean %>% 
  filter(temperature_min < -40) %>% 
  count(waterYear)

snotel_327_cull_count

# filtering for too few observations in a year
snotel_327_cull_count_days <- snotel_327_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_327_cull_count_days

```

1983, 1994, 2003 need to be culled.

```{r 327 cull}

snotel_327_clean_culled <- snotel_327_clean %>% 
  filter(waterYear != "1983" & waterYear != "1994" & waterYear != "2003") #%>% 
  #filter(temperature_mean > -49)


```

```{r 327 culled plot, eval=FALSE, include=FALSE}

ggplot(snotel_327_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```

### Beartown (327) NOT ADJUSTED.  

2005-04-18 installed ext range sensor. 
*Original*

```{r 327 adj}

snotel_327_adjusted <- snotel_327_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2005-04-18", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 327 Detrended

```{r 327 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_327 <- snotel_327_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_327 <- yearly_wy_aver_327 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_327 <- daily_wy_aver_327 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_327$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_327 <-daily_wy_aver_327 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_327$date_temp <- signif(daily_wy_aver2_327$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_327, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 327 SD 

```{r 327 SD}

standard_dev_327 <- daily_wy_aver_327 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_327 <- standard_dev_327 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_327 <- standard_dev_all_327 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_327 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_327, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 327 average temperatures for water years 2005-2021* 


#### MK & SS for 327 (non-corrected)

```{r 327 sd mk & ss non corrected}

sd_mk_327 <- mk.test(standard_dev_all_327$sd_2)
print(sd_mk_327)

sd_sens_327 <- sens.slope(standard_dev_all_327$sd_2)
print(sd_sens_327)

```




### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 327 SD summer NOT CORRECTED}
summer_standard_dev_all_327 <- standard_dev_327 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_327 <- summer_standard_dev_all_327 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_327 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_327, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 327 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 327 (non-corrected)

```{r 327 sd summer mk & ss non corrected}

summer_sd_mk_327 <- mk.test(summer_standard_dev_all_327$sd_2)
print(summer_sd_mk_327)

summer_sd_sens_327 <- sens.slope(summer_standard_dev_all_327$sd_2)
print(summer_sd_sens_327)

```

Winter
```{r 327 SD winter NOT CORRECTED}
winter_standard_dev_all_327 <- standard_dev_327 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_327 <- winter_standard_dev_all_327 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_327 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_327, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 327 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 327 (non-corrected)

```{r 327 sd winter mk & ss non corrected}

winter_sd_mk_327 <- mk.test(winter_standard_dev_all_327$sd_2)
print(winter_sd_mk_327)

winter_sd_sens_327 <- sens.slope(winter_standard_dev_all_327$sd_2)
print(winter_sd_sens_327)

```


### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 327 SD spring NOT CORRECTED}
spring_standard_dev_all_327 <- standard_dev_327 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_327 <- spring_standard_dev_all_327 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_327 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_327, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 327 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 327 (non-corrected)

```{r 327 sd spring mk & ss non corrected}

spring_sd_mk_327 <- mk.test(spring_standard_dev_all_327$sd_2)
print(spring_sd_mk_327)

spring_sd_sens_327 <- sens.slope(spring_standard_dev_all_327$sd_2)
print(spring_sd_sens_327)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 327 SD fall NOT CORRECTED}
fall_standard_dev_all_327 <- standard_dev_327 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_327 <- fall_standard_dev_all_327 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_327 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_327, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 327 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 327 (non-corrected)

```{r 327 sd fall mk & ss non corrected}

fall_sd_mk_327 <- mk.test(fall_standard_dev_all_327$sd_2)
print(fall_sd_mk_327)

fall_sd_sens_327 <- sens.slope(fall_standard_dev_all_327$sd_2)
print(fall_sd_sens_327)

```



# Cascade #2	387
*Morrisey* 6/18/2004

```{r filter Beartown (387) station}

snotel_387 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "387")

```

```{r 387 clean & water year & day }
#str(snotel_387) # check the date, usually a character.  

snotel_387$Date <- as.Date(snotel_387$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_387_clean <- snotel_387 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_387_clean <- snotel_387_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 387 plot check }

# Check for outliers

ggplot(snotel_387_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```



```{r 387 trying to clean outliers}

snotel_387_clean <- snotel_387_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_min > -40) %>% 
  filter(temperature_mean > -40)

```


```{r 387 temp difference update}

ggplot(snotel_387_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')


temp_387_xts <- xts(snotel_387_clean$temperature_mean, order.by = snotel_387_clean$Date)

dygraph(temp_387_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 387 cull selection}

# filtering for temperature anomalies
snotel_387_cull_count <- snotel_387_clean %>% 
  filter(temperature_min > -40) %>% 
  count(waterYear)

snotel_387_cull_count

# filtering for too few observations in a year
snotel_387_cull_count_days <- snotel_387_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_387_cull_count_days

```

1993, 1994, 2018, 2022 need to be culled.

```{r 387 cull}

snotel_387_clean_culled <- snotel_387_clean %>% 
  filter(waterYear != "1993" & waterYear != "1994" & waterYear != "2018" & waterYear != "2022") #%>% 
  #filter(temperature_mean > -49)


```

```{r 387 culled plot, eval=FALSE, include=FALSE}

ggplot(snotel_387_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```

### Cascade #2	(387) NOT ADJUSTED.  

*Morrisey* 6/18/2004

```{r 387 adj}

snotel_387_adjusted <- snotel_387_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2004-06-18", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 387 Detrended

```{r 387 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_387 <- snotel_387_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

#THIS IS WRONG.
#daily_wy_aver_387 <- yearly_wy_aver_387 %>% 
#  group_by(daymonth) %>% 
# mutate(aver_day_temp = mean(temperature_mean))

#TRYING:
daily_wy_aver_387 <- yearly_wy_aver_387 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))


#average mean temperature by day for the period of record:

daily_wy_aver_387 <- daily_wy_aver_387 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_387$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_387 <-daily_wy_aver_387 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_387$date_temp <- signif(daily_wy_aver2_387$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_387, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 387 SD 

```{r 387 SD}

standard_dev_387 <- daily_wy_aver_387 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

detrend_check <- standard_dev_387 %>% 
  filter(waterYear == 2000)

ggplot(detrend_check, aes(x = waterDay, y = residual))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')



standard_dev_all_387 <- standard_dev_387 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_387 <- standard_dev_all_387 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_387 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_387, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 387 average temperatures for water years 2005-2021* 


#### MK & SS for 387 (non-corrected)
```{r 387 sd mk & ss non corrected}
# Thus is giving an error, omitting it as it does not matter due to the correction. 
sd_mk_387 <- mk.test(standard_dev_all_387$sd_2)
print(sd_mk_387)

sd_sens_387 <- sens.slope(standard_dev_all_387$sd_2)
print(sd_sens_387)

```

#### Corrected


#### 387 Detrended (corrected)

```{r 387 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_387_ad <- snotel_387_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
# WRONG.
# daily_wy_aver_387_ad <- yearly_wy_aver_387_ad %>% 
#   group_by(daymonth) %>% 
#   mutate(aver_day_temp_ad = mean(temp_ad))

#CORRECT:

daily_wy_aver_387_ad <- yearly_wy_aver_387_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))


#average mean temperature by day for the period of record:
daily_wy_aver_387_ad <- daily_wy_aver_387_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_387_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_387_ad <-daily_wy_aver_387_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_387_ad$date_temp_ad <- signif(daily_wy_aver2_387_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_387_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 387 SS (corrected)

```{r 387 SD adjusted}
standard_dev_387_ad <- daily_wy_aver_387_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_387_ad <- standard_dev_387_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_387_ad <- standard_dev_all_387_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_387_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_387_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 387 average temperatures for water years 1986-2021* 


#### MK & SS 387 (corrected)

```{r 387 sd mk & ss adjusted}
sd_mk_387_ad <- mk.test(standard_dev_all_387_ad$sd_2)
print(sd_mk_387_ad)

sd_sens_387_ad <- sens.slope(standard_dev_all_387_ad$sd_2)
print(sd_sens_387_ad)

```


### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 387 SD summer NOT CORRECTED}
summer_standard_dev_all_387 <- standard_dev_387 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_387 <- summer_standard_dev_all_387 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_387 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_387, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 387 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 387 (non-corrected)

```{r 387 sd summer mk & ss non corrected}

summer_sd_mk_387 <- mk.test(summer_standard_dev_all_387$sd_2)
print(summer_sd_mk_387)

summer_sd_sens_387 <- sens.slope(summer_standard_dev_all_387$sd_2)
print(summer_sd_sens_387)

```



Winter
```{r 387 SD winter NOT CORRECTED}
winter_standard_dev_all_387 <- standard_dev_387 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_387 <- winter_standard_dev_all_387 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_387 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_387, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 387 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 387 (non-corrected)

```{r 387 sd winter mk & ss non corrected}

winter_sd_mk_387 <- mk.test(winter_standard_dev_all_387$sd_2)
print(winter_sd_mk_387)

winter_sd_sens_387 <- sens.slope(winter_standard_dev_all_387$sd_2)
print(winter_sd_sens_387)

```


### Summer and Winter SD CORRECTED

Summer
```{r 387 SD Summer}
summer_standard_dev_all_387_ad <- standard_dev_387_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_387_ad <- summer_standard_dev_all_387_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_387_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_387_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 387 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 387 (corrected)

```{r 387 summer sd mk & ss adjusted}
summer_sd_mk_387_ad <- mk.test(summer_standard_dev_all_387_ad$sd_2)
print(summer_sd_mk_387_ad)

summer_sd_sens_387_ad <- sens.slope(summer_standard_dev_all_387_ad$sd_2)
print(summer_sd_sens_387_ad)

```


Winter
```{r 387 SD winter}
winter_standard_dev_all_387_ad <- standard_dev_387_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_387_ad <- winter_standard_dev_all_387_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_387_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_387_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 387 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 387 (corrected)

```{r 387 winter sd mk & ss adjusted}
winter_sd_mk_387_ad <- mk.test(winter_standard_dev_all_387_ad$sd_2)
print(winter_sd_mk_387_ad)

winter_sd_sens_387_ad <- sens.slope(winter_standard_dev_all_387_ad$sd_2)
print(winter_sd_sens_387_ad)

```


### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 387 SD spring NOT CORRECTED}
spring_standard_dev_all_387 <- standard_dev_387 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_387 <- spring_standard_dev_all_387 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_387 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_387, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 387 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 387 (non-corrected)

```{r 387 sd spring mk & ss non corrected}

spring_sd_mk_387 <- mk.test(spring_standard_dev_all_387$sd_2)
print(spring_sd_mk_387)

spring_sd_sens_387 <- sens.slope(spring_standard_dev_all_387$sd_2)
print(spring_sd_sens_387)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 387 SD fall NOT CORRECTED}
fall_standard_dev_all_387 <- standard_dev_387 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_387 <- fall_standard_dev_all_387 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_387 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_387, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 387 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 387 (non-corrected)

```{r 387 sd fall mk & ss non corrected}

fall_sd_mk_387 <- mk.test(fall_standard_dev_all_387$sd_2)
print(fall_sd_mk_387)

fall_sd_sens_387 <- sens.slope(fall_standard_dev_all_387$sd_2)
print(fall_sd_sens_387)

```


### Spring and Fall SD CORRECTED

Spring
```{r 387 SD Spring}
spring_standard_dev_all_387_ad <- standard_dev_387_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_387_ad <- spring_standard_dev_all_387_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_387_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_387_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 387 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 387 (corrected)

```{r 387 spring sd mk & ss adjusted}
spring_sd_mk_387_ad <- mk.test(spring_standard_dev_all_387_ad$sd_2)
print(spring_sd_mk_387_ad)

spring_sd_sens_387_ad <- sens.slope(spring_standard_dev_all_387_ad$sd_2)
print(spring_sd_sens_387_ad)

```


Fall
```{r 387 SD fall}
fall_standard_dev_all_387_ad <- standard_dev_387_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_387_ad <- fall_standard_dev_all_387_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_387_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_387_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 387 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 387 (corrected)

```{r 387 fall sd mk & ss adjusted}
fall_sd_mk_387_ad <- mk.test(fall_standard_dev_all_387_ad$sd_2)
print(fall_sd_mk_387_ad)

fall_sd_sens_387_ad <- sens.slope(fall_standard_dev_all_387_ad$sd_2)
print(fall_sd_sens_387_ad)

```

# Cumbres Trestle	431 
*Oyler -> Morrisey* 6/8/2005


```{r filter Cumbres Trestle (431) station}

snotel_431 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "431")

```

```{r 431 clean & water year & day }
#str(snotel_431) # check the date, usually a character.  

snotel_431$Date <- as.Date(snotel_431$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_431_clean <- snotel_431 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_431_clean <- snotel_431_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 431 plot check }

# Check for outliers

ggplot(snotel_431_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```



```{r 431 trying to clean outliers}



snotel_431_clean <- snotel_431_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_min > -40) %>% 
  filter(temperature_min < 25)

```


```{r 431 temp difference}

ggplot(snotel_431_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 431 cull selection}

# filtering for temperature anomalies
snotel_431_cull_count <- snotel_431_clean %>% 
  filter(temperature_min > -40) %>% 
  count(waterYear)

snotel_431_cull_count

# filtering for too few observations in a year
snotel_431_cull_count_days <- snotel_431_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_431_cull_count_days

```

1987, 1988, 1990, 1991, 1992, 1994, 2014 need to be culled.

```{r 431 cull}

snotel_431_clean_culled <- snotel_431_clean %>% 
  filter(waterYear != "1987" & waterYear != "1988" & waterYear != "1990" & waterYear != "1991" & waterYear != "1992" & waterYear != "1994" & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)


```

```{r 431 culled plot}

ggplot(snotel_431_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_431_xts <- xts(snotel_431_clean_culled$temperature_mean, order.by = snotel_431_clean_culled$Date)

dygraph(temp_431_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

snotel_431_clean_culled <- snotel_431_clean_culled %>% 
  filter(temperature_mean < 20)

temp_431_xts <- xts(snotel_431_clean_culled$temperature_mean, order.by = snotel_431_clean_culled$Date)

dygraph(temp_431_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Cumbres Trestle	431 
*Oyler -> Morrisey* 6/8/2005

```{r 431 adj}

snotel_431_adjusted <- snotel_431_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2005-06-08", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 431 Detrended

```{r 431 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_431 <- snotel_431_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_431 <- yearly_wy_aver_431 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_431 <- daily_wy_aver_431 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_431$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_431 <-daily_wy_aver_431 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_431$date_temp <- signif(daily_wy_aver2_431$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_431, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 431 SD 

```{r 431 SD}

standard_dev_431 <- daily_wy_aver_431 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_431 <- standard_dev_431 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_431 <- standard_dev_all_431 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_431 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_431, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 431 average temperatures for water years 2005-2021* 


#### MK & SS for 431 (non-corrected)

```{r 431 sd mk & ss non corrected}

sd_mk_431 <- mk.test(standard_dev_all_431$sd_2)
print(sd_mk_431)

sd_sens_431 <- sens.slope(standard_dev_all_431$sd_2)
print(sd_sens_431)

```

#### Corrected


#### 431 Detrended (corrected)

```{r 431 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_431_ad <- snotel_431_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_431_ad <- yearly_wy_aver_431_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_431_ad <- daily_wy_aver_431_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_431_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_431_ad <-daily_wy_aver_431_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_431_ad$date_temp_ad <- signif(daily_wy_aver2_431_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_431_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 431 SS (corrected)

```{r 431 SD adjusted}
standard_dev_431_ad <- daily_wy_aver_431_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_431_ad <- standard_dev_431_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_431_ad <- standard_dev_all_431_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_431_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_431_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 431 average temperatures for water years 1986-2021* 


#### MK & SS 431 (corrected)

```{r 431 sd mk & ss adjusted}
sd_mk_431_ad <- mk.test(standard_dev_all_431_ad$sd_2)
print(sd_mk_431_ad)

sd_sens_431_ad <- sens.slope(standard_dev_all_431_ad$sd_2)
print(sd_sens_431_ad)

```






### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 431 SD summer NOT CORRECTED}
summer_standard_dev_all_431 <- standard_dev_431 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_431 <- summer_standard_dev_all_431 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_431 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_431, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 431 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 431 (non-corrected)

```{r 431 sd summer mk & ss non corrected}

summer_sd_mk_431 <- mk.test(summer_standard_dev_all_431$sd_2)
print(summer_sd_mk_431)

summer_sd_sens_431 <- sens.slope(summer_standard_dev_all_431$sd_2)
print(summer_sd_sens_431)

```

Winter
```{r 431 SD winter NOT CORRECTED}
winter_standard_dev_all_431 <- standard_dev_431 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_431 <- winter_standard_dev_all_431 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_431 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_431, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 431 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 431 (non-corrected)

```{r 431 sd winter mk & ss non corrected}

winter_sd_mk_431 <- mk.test(winter_standard_dev_all_431$sd_2)
print(winter_sd_mk_431)

winter_sd_sens_431 <- sens.slope(winter_standard_dev_all_431$sd_2)
print(winter_sd_sens_431)

```



### Summer and Winter SD CORRECTED

Summer
```{r 431 SD Summer}
summer_standard_dev_all_431_ad <- standard_dev_431_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_431_ad <- summer_standard_dev_all_431_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_431_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_431_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 431 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 431 (corrected)

```{r 431 summer sd mk & ss adjusted}
summer_sd_mk_431_ad <- mk.test(summer_standard_dev_all_431_ad$sd_2)
print(summer_sd_mk_431_ad)

summer_sd_sens_431_ad <- sens.slope(summer_standard_dev_all_431_ad$sd_2)
print(summer_sd_sens_431_ad)

```

Winter
```{r 431 SD winter}
winter_standard_dev_all_431_ad <- standard_dev_431_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_431_ad <- winter_standard_dev_all_431_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_431_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_431_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 431 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 431 (corrected)

```{r 431 winter sd mk & ss adjusted}
winter_sd_mk_431_ad <- mk.test(winter_standard_dev_all_431_ad$sd_2)
print(winter_sd_mk_431_ad)

winter_sd_sens_431_ad <- sens.slope(winter_standard_dev_all_431_ad$sd_2)
print(winter_sd_sens_431_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 431 SD spring NOT CORRECTED}
spring_standard_dev_all_431 <- standard_dev_431 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_431 <- spring_standard_dev_all_431 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_431 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_431, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 431 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 431 (non-corrected)

```{r 431 sd spring mk & ss non corrected}

spring_sd_mk_431 <- mk.test(spring_standard_dev_all_431$sd_2)
print(spring_sd_mk_431)

spring_sd_sens_431 <- sens.slope(spring_standard_dev_all_431$sd_2)
print(spring_sd_sens_431)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 431 SD fall NOT CORRECTED}
fall_standard_dev_all_431 <- standard_dev_431 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_431 <- fall_standard_dev_all_431 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_431 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_431, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 431 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 431 (non-corrected)

```{r 431 sd fall mk & ss non corrected}

fall_sd_mk_431 <- mk.test(fall_standard_dev_all_431$sd_2)
print(fall_sd_mk_431)

fall_sd_sens_431 <- sens.slope(fall_standard_dev_all_431$sd_2)
print(fall_sd_sens_431)

```



### Spring and Fall SD CORRECTED

Spring
```{r 431 SD Spring}
spring_standard_dev_all_431_ad <- standard_dev_431_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_431_ad <- spring_standard_dev_all_431_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_431_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_431_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 431 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 431 (corrected)

```{r 431 spring sd mk & ss adjusted}
spring_sd_mk_431_ad <- mk.test(spring_standard_dev_all_431_ad$sd_2)
print(spring_sd_mk_431_ad)

spring_sd_sens_431_ad <- sens.slope(spring_standard_dev_all_431_ad$sd_2)
print(spring_sd_sens_431_ad)

```

Fall
```{r 431 SD fall}
fall_standard_dev_all_431_ad <- standard_dev_431_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_431_ad <- fall_standard_dev_all_431_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_431_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_431_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 431 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 431 (corrected)

```{r 431 fall sd mk & ss adjusted}
fall_sd_mk_431_ad <- mk.test(fall_standard_dev_all_431_ad$sd_2)
print(fall_sd_mk_431_ad)

fall_sd_sens_431_ad <- sens.slope(fall_standard_dev_all_431_ad$sd_2)
print(fall_sd_sens_431_ad)

```



# Idarado	538 
*Morrisey* 7/12/2004

```{r filter Idarado (538) station}

snotel_538 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "538")

```

```{r 538 clean & water year & day }
#str(snotel_538) # check the date, usually a character.  

snotel_538$Date <- as.Date(snotel_538$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_538_clean <- snotel_538 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_538_clean <- snotel_538_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 538 plot check }

# Check for outliers

ggplot(snotel_538_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 538 trying to clean outliers}



snotel_538_clean <- snotel_538_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40)# %>% 
  #filter(temperature_min < 25)

```


```{r 538 temp difference}

ggplot(snotel_538_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 538 cull selection}

# filtering for temperature anomalies
snotel_538_cull_count <- snotel_538_clean %>% 
  filter(temperature_min > -40) %>% 
  count(waterYear)

snotel_538_cull_count

# filtering for too few observations in a year
snotel_538_cull_count_days <- snotel_538_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_538_cull_count_days

```

1991 and 1993 need to be culled.

```{r 538 cull}

snotel_538_clean_culled <- snotel_538_clean %>% 
  filter(waterYear != "1991" & waterYear != "1993") # & waterYear != "1990" & waterYear != "1991" & waterYear != "1992" & waterYear != "1994" & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)


```

```{r 538 culled plot}

ggplot(snotel_538_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_538_xts <- xts(snotel_538_clean_culled$temperature_mean, order.by = snotel_538_clean_culled$Date)

dygraph(temp_538_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

snotel_538_clean_culled <- snotel_538_clean_culled %>% 
  filter(temperature_mean < 20)

temp_538_xts <- xts(snotel_538_clean_culled$temperature_mean, order.by = snotel_538_clean_culled$Date)

dygraph(temp_538_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Idarado	538 
*Morrisey* 7/12/2004

```{r 538 adj}

snotel_538_adjusted <- snotel_538_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2004-07-12", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 538 Detrended

```{r 538 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_538 <- snotel_538_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_538 <- yearly_wy_aver_538 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_538 <- daily_wy_aver_538 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_538$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_538 <-daily_wy_aver_538 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_538$date_temp <- signif(daily_wy_aver2_538$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_538, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 538 SD 

```{r 538 SD}

standard_dev_538 <- daily_wy_aver_538 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_538 <- standard_dev_538 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_538 <- standard_dev_all_538 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_538 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_538, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 538 average temperatures for water years 2005-2021* 


#### MK & SS for 538 (non-corrected)

```{r 538 sd mk & ss non corrected}

sd_mk_538 <- mk.test(standard_dev_all_538$sd_2)
print(sd_mk_538)

sd_sens_538 <- sens.slope(standard_dev_all_538$sd_2)
print(sd_sens_538)

```

#### Corrected


#### 538 Detrended (corrected)

```{r 538 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_538_ad <- snotel_538_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_538_ad <- yearly_wy_aver_538_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_538_ad <- daily_wy_aver_538_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_538_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_538_ad <-daily_wy_aver_538_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_538_ad$date_temp_ad <- signif(daily_wy_aver2_538_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_538_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 538 SS (corrected)

```{r 538 SD adjusted}
standard_dev_538_ad <- daily_wy_aver_538_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_538_ad <- standard_dev_538_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_538_ad <- standard_dev_all_538_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_538_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_538_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 538 average temperatures for water years 1986-2021* 


#### MK & SS 538 (corrected)

```{r 538 sd mk & ss adjusted}
sd_mk_538_ad <- mk.test(standard_dev_all_538_ad$sd_2)
print(sd_mk_538_ad)

sd_sens_538_ad <- sens.slope(standard_dev_all_538_ad$sd_2)
print(sd_sens_538_ad)

```




### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 538 SD summer NOT CORRECTED}
summer_standard_dev_all_538 <- standard_dev_538 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_538 <- summer_standard_dev_all_538 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_538 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_538, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 538 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 538 (non-corrected)

```{r 538 sd summer mk & ss non corrected}

summer_sd_mk_538 <- mk.test(summer_standard_dev_all_538$sd_2)
print(summer_sd_mk_538)

summer_sd_sens_538 <- sens.slope(summer_standard_dev_all_538$sd_2)
print(summer_sd_sens_538)

```

Winter
```{r 538 SD winter NOT CORRECTED}
winter_standard_dev_all_538 <- standard_dev_538 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_538 <- winter_standard_dev_all_538 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_538 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_538, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 538 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 538 (non-corrected)

```{r 538 sd winter mk & ss non corrected}

winter_sd_mk_538 <- mk.test(winter_standard_dev_all_538$sd_2)
print(winter_sd_mk_538)

winter_sd_sens_538 <- sens.slope(winter_standard_dev_all_538$sd_2)
print(winter_sd_sens_538)

```



### Summer and Winter SD CORRECTED

Summer
```{r 538 SD Summer}
summer_standard_dev_all_538_ad <- standard_dev_538_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_538_ad <- summer_standard_dev_all_538_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_538_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_538_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 538 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 538 (corrected)

```{r 538 summer sd mk & ss adjusted}
summer_sd_mk_538_ad <- mk.test(summer_standard_dev_all_538_ad$sd_2)
print(summer_sd_mk_538_ad)

summer_sd_sens_538_ad <- sens.slope(summer_standard_dev_all_538_ad$sd_2)
print(summer_sd_sens_538_ad)

```

Winter
```{r 538 SD winter}
winter_standard_dev_all_538_ad <- standard_dev_538_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_538_ad <- winter_standard_dev_all_538_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_538_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_538_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 538 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 538 (corrected)

```{r 538 winter sd mk & ss adjusted}
winter_sd_mk_538_ad <- mk.test(winter_standard_dev_all_538_ad$sd_2)
print(winter_sd_mk_538_ad)

winter_sd_sens_538_ad <- sens.slope(winter_standard_dev_all_538_ad$sd_2)
print(winter_sd_sens_538_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 538 SD spring NOT CORRECTED}
spring_standard_dev_all_538 <- standard_dev_538 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_538 <- spring_standard_dev_all_538 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_538 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_538, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 538 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 538 (non-corrected)

```{r 538 sd spring mk & ss non corrected}

spring_sd_mk_538 <- mk.test(spring_standard_dev_all_538$sd_2)
print(spring_sd_mk_538)

spring_sd_sens_538 <- sens.slope(spring_standard_dev_all_538$sd_2)
print(spring_sd_sens_538)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 538 SD fall NOT CORRECTED}
fall_standard_dev_all_538 <- standard_dev_538 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_538 <- fall_standard_dev_all_538 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_538 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_538, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 538 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 538 (non-corrected)

```{r 538 sd fall mk & ss non corrected}

fall_sd_mk_538 <- mk.test(fall_standard_dev_all_538$sd_2)
print(fall_sd_mk_538)

fall_sd_sens_538 <- sens.slope(fall_standard_dev_all_538$sd_2)
print(fall_sd_sens_538)

```



### Spring and Fall SD CORRECTED

Spring
```{r 538 SD Spring}
spring_standard_dev_all_538_ad <- standard_dev_538_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_538_ad <- spring_standard_dev_all_538_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_538_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_538_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 538 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 538 (corrected)

```{r 538 spring sd mk & ss adjusted}
spring_sd_mk_538_ad <- mk.test(spring_standard_dev_all_538_ad$sd_2)
print(spring_sd_mk_538_ad)

spring_sd_sens_538_ad <- sens.slope(spring_standard_dev_all_538_ad$sd_2)
print(spring_sd_sens_538_ad)

```

Fall
```{r 538 SD fall}
fall_standard_dev_all_538_ad <- standard_dev_538_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_538_ad <- fall_standard_dev_all_538_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_538_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_538_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 538 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 538 (corrected)

```{r 538 fall sd mk & ss adjusted}
fall_sd_mk_538_ad <- mk.test(fall_standard_dev_all_538_ad$sd_2)
print(fall_sd_mk_538_ad)

fall_sd_sens_538_ad <- sens.slope(fall_standard_dev_all_538_ad$sd_2)
print(fall_sd_sens_538_ad)

```



# Lone Cone 589 
*Oyler -> Morrisey* 6/22/2005

```{r filter Cumbres Trestle (589) station}

snotel_589 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "589")

```

```{r 589 clean & water year & day }
#str(snotel_589) # check the date, usually a character.  

snotel_589$Date <- as.Date(snotel_589$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_589_clean <- snotel_589 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_589_clean <- snotel_589_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 589 plot check }

# Check for outliers

ggplot(snotel_589_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 589 trying to clean outliers}



snotel_589_clean <- snotel_589_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40)# %>% 
  #filter(temperature_min < 25)

```


```{r 589 temp difference}

ggplot(snotel_589_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 589 cull selection}

# filtering for temperature anomalies
snotel_589_cull_count <- snotel_589_clean %>% 
  filter(temperature_min > -40) %>% 
  count(waterYear)

snotel_589_cull_count

# filtering for too few observations in a year
snotel_589_cull_count_days <- snotel_589_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_589_cull_count_days

```

1986, 1994, 1997, 2006, 2009, 2010, 2011, 2012, 2013, 2014 need to be culled.

```{r 589 cull}

snotel_589_clean_culled <- snotel_589_clean %>% 
  filter(waterYear != "1986" & waterYear != "1994" & waterYear != "1997" & waterYear != "2006" & waterYear != "2009" & waterYear != "2010" & waterYear != "2011" & waterYear != "2012" & waterYear != "2013" & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)


```

```{r 589 culled plot}

ggplot(snotel_589_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_589_xts <- xts(snotel_589_clean_culled$temperature_mean, order.by = snotel_589_clean_culled$Date)

dygraph(temp_589_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

snotel_589_clean_culled <- snotel_589_clean_culled %>% 
  filter(temperature_mean < 20)

temp_589_xts <- xts(snotel_589_clean_culled$temperature_mean, order.by = snotel_589_clean_culled$Date)

dygraph(temp_589_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Lone Cone 589 
*Oyler -> Morrisey* 6/22/2005

```{r 589 adj}

snotel_589_adjusted <- snotel_589_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2005-06-22", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 589 Detrended

```{r 589 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_589 <- snotel_589_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_589 <- yearly_wy_aver_589 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_589 <- daily_wy_aver_589 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_589$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_589 <-daily_wy_aver_589 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_589$date_temp <- signif(daily_wy_aver2_589$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_589, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 589 SD 

```{r 589 SD}

standard_dev_589 <- daily_wy_aver_589 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_589 <- standard_dev_589 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_589 <- standard_dev_all_589 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_589 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_589, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 589 average temperatures for water years 2005-2021* 


#### MK & SS for 589 (non-corrected)

```{r 589 sd mk & ss non corrected}

sd_mk_589 <- mk.test(standard_dev_all_589$sd_2)
print(sd_mk_589)

sd_sens_589 <- sens.slope(standard_dev_all_589$sd_2)
print(sd_sens_589)

```

#### Corrected


#### 589 Detrended (corrected)

```{r 589 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_589_ad <- snotel_589_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_589_ad <- yearly_wy_aver_589_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_589_ad <- daily_wy_aver_589_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_589_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_589_ad <-daily_wy_aver_589_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_589_ad$date_temp_ad <- signif(daily_wy_aver2_589_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_589_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 589 SS (corrected)

```{r 589 SD adjusted}
standard_dev_589_ad <- daily_wy_aver_589_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_589_ad <- standard_dev_589_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_589_ad <- standard_dev_all_589_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_589_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_589_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 589 average temperatures for water years 1986-2021* 


#### MK & SS 589 (corrected)

```{r 589 sd mk & ss adjusted}
sd_mk_589_ad <- mk.test(standard_dev_all_589_ad$sd_2)
print(sd_mk_589_ad)

sd_sens_589_ad <- sens.slope(standard_dev_all_589_ad$sd_2)
print(sd_sens_589_ad)

```



### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 589 SD summer NOT CORRECTED}
summer_standard_dev_all_589 <- standard_dev_589 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_589 <- summer_standard_dev_all_589 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_589 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_589, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 589 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 589 (non-corrected)

```{r 589 sd summer mk & ss non corrected}

summer_sd_mk_589 <- mk.test(summer_standard_dev_all_589$sd_2)
print(summer_sd_mk_589)

summer_sd_sens_589 <- sens.slope(summer_standard_dev_all_589$sd_2)
print(summer_sd_sens_589)

```

Winter
```{r 589 SD winter NOT CORRECTED}
winter_standard_dev_all_589 <- standard_dev_589 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_589 <- winter_standard_dev_all_589 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_589 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_589, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 589 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 589 (non-corrected)

```{r 589 sd winter mk & ss non corrected}

winter_sd_mk_589 <- mk.test(winter_standard_dev_all_589$sd_2)
print(winter_sd_mk_589)

winter_sd_sens_589 <- sens.slope(winter_standard_dev_all_589$sd_2)
print(winter_sd_sens_589)

```



### Summer and Winter SD CORRECTED

Summer
```{r 589 SD Summer}
summer_standard_dev_all_589_ad <- standard_dev_589_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_589_ad <- summer_standard_dev_all_589_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_589_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_589_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 589 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 589 (corrected)

```{r 589 summer sd mk & ss adjusted}
summer_sd_mk_589_ad <- mk.test(summer_standard_dev_all_589_ad$sd_2)
print(summer_sd_mk_589_ad)

summer_sd_sens_589_ad <- sens.slope(summer_standard_dev_all_589_ad$sd_2)
print(summer_sd_sens_589_ad)

```

Winter
```{r 589 SD winter}
winter_standard_dev_all_589_ad <- standard_dev_589_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_589_ad <- winter_standard_dev_all_589_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_589_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_589_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 589 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 589 (corrected)

```{r 589 winter sd mk & ss adjusted}
winter_sd_mk_589_ad <- mk.test(winter_standard_dev_all_589_ad$sd_2)
print(winter_sd_mk_589_ad)

winter_sd_sens_589_ad <- sens.slope(winter_standard_dev_all_589_ad$sd_2)
print(winter_sd_sens_589_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 589 SD spring NOT CORRECTED}
spring_standard_dev_all_589 <- standard_dev_589 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_589 <- spring_standard_dev_all_589 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_589 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_589, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 589 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 589 (non-corrected)

```{r 589 sd spring mk & ss non corrected}

spring_sd_mk_589 <- mk.test(spring_standard_dev_all_589$sd_2)
print(spring_sd_mk_589)

spring_sd_sens_589 <- sens.slope(spring_standard_dev_all_589$sd_2)
print(spring_sd_sens_589)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 589 SD fall NOT CORRECTED}
fall_standard_dev_all_589 <- standard_dev_589 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_589 <- fall_standard_dev_all_589 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_589 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_589, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 589 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 589 (non-corrected)

```{r 589 sd fall mk & ss non corrected}

fall_sd_mk_589 <- mk.test(fall_standard_dev_all_589$sd_2)
print(fall_sd_mk_589)

fall_sd_sens_589 <- sens.slope(fall_standard_dev_all_589$sd_2)
print(fall_sd_sens_589)

```



### Spring and Fall SD CORRECTED

Spring
```{r 589 SD Spring}
spring_standard_dev_all_589_ad <- standard_dev_589_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_589_ad <- spring_standard_dev_all_589_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_589_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_589_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 589 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 589 (corrected)

```{r 589 spring sd mk & ss adjusted}
spring_sd_mk_589_ad <- mk.test(spring_standard_dev_all_589_ad$sd_2)
print(spring_sd_mk_589_ad)

spring_sd_sens_589_ad <- sens.slope(spring_standard_dev_all_589_ad$sd_2)
print(spring_sd_sens_589_ad)

```

Fall
```{r 589 SD fall}
fall_standard_dev_all_589_ad <- standard_dev_589_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_589_ad <- fall_standard_dev_all_589_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_589_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_589_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 589 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 589 (corrected)

```{r 589 fall sd mk & ss adjusted}
fall_sd_mk_589_ad <- mk.test(fall_standard_dev_all_589_ad$sd_2)
print(fall_sd_mk_589_ad)

fall_sd_sens_589_ad <- sens.slope(fall_standard_dev_all_589_ad$sd_2)
print(fall_sd_sens_589_ad)

```



# Middle Creek 624
*Morrisey* 6/26/2006

```{r filter Middle Creek (624) station}

snotel_624 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "624")

```

```{r 624 clean & water year & day }
#str(snotel_624) # check the date, usually a character.  

snotel_624$Date <- as.Date(snotel_624$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_624_clean <- snotel_624 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_624_clean <- snotel_624_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 624 plot check }

# Check for outliers

ggplot(snotel_624_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 624 trying to clean outliers}



snotel_624_clean <- snotel_624_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 25)

```


```{r 624 temp difference}

ggplot(snotel_624_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 624 cull selection}

# filtering for temperature anomalies
snotel_624_cull_count <- snotel_624_clean %>% 
  filter(temperature_min > -40) %>% 
  count(waterYear)

snotel_624_cull_count

# filtering for too few observations in a year
snotel_624_cull_count_days <- snotel_624_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_624_cull_count_days

```

1980, 1982, 1983, 1988, 1991, 1993, 1994, 2021, 2022 need to be culled.

```{r 624 cull}

snotel_624_clean_culled <- snotel_624_clean %>% 
  filter(waterYear != "1980" & waterYear != "1981" & waterYear != "1982" & waterYear != "1983" & waterYear != "1988" & waterYear != "1991" & waterYear != "1993" & waterYear != "1994" & waterYear != "2021" & waterYear != "2022")# & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_624_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 624 culled plot}

ggplot(snotel_624_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_624_xts <- xts(snotel_624_clean_culled$temperature_mean, order.by = snotel_624_clean_culled$Date)

dygraph(temp_624_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

snotel_624_clean_culled <- snotel_624_clean_culled %>% 
  filter(temperature_mean < 20)

temp_624_xts <- xts(snotel_624_clean_culled$temperature_mean, order.by = snotel_624_clean_culled$Date)

dygraph(temp_624_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Middle Creek	624 *Morrisey* 6/26/2006

```{r 624 adj}

snotel_624_adjusted <- snotel_624_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2006-06-26", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 624 Detrended

```{r 624 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_624 <- snotel_624_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_624 <- yearly_wy_aver_624 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_624 <- daily_wy_aver_624 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_624$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_624 <-daily_wy_aver_624 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_624$date_temp <- signif(daily_wy_aver2_624$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_624, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 624 SD 

```{r 624 SD}

standard_dev_624 <- daily_wy_aver_624 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_624 <- standard_dev_624 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_624 <- standard_dev_all_624 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_624 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_624, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 624 average temperatures for water years 2005-2021* 


#### MK & SS for 624 (non-corrected)

```{r 624 sd mk & ss non corrected}

sd_mk_624 <- mk.test(standard_dev_all_624$sd_2)
print(sd_mk_624)

sd_sens_624 <- sens.slope(standard_dev_all_624$sd_2)
print(sd_sens_624)

```

#### Corrected


#### 624 Detrended (corrected)

```{r 624 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_624_ad <- snotel_624_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_624_ad <- yearly_wy_aver_624_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_624_ad <- daily_wy_aver_624_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_624_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_624_ad <-daily_wy_aver_624_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_624_ad$date_temp_ad <- signif(daily_wy_aver2_624_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_624_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 624 SS (corrected)

```{r 624 SD adjusted}
standard_dev_624_ad <- daily_wy_aver_624_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_624_ad <- standard_dev_624_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_624_ad <- standard_dev_all_624_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_624_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_624_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 624 average temperatures for water years 1986-2021* 


#### MK & SS 624 (corrected)

```{r 624 sd mk & ss adjusted}
sd_mk_624_ad <- mk.test(standard_dev_all_624_ad$sd_2)
print(sd_mk_624_ad)

sd_sens_624_ad <- sens.slope(standard_dev_all_624_ad$sd_2)
print(sd_sens_624_ad)

```



### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 624 SD summer NOT CORRECTED}
summer_standard_dev_all_624 <- standard_dev_624 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_624 <- summer_standard_dev_all_624 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_624 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_624, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 624 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 624 (non-corrected)

```{r 624 sd summer mk & ss non corrected}

summer_sd_mk_624 <- mk.test(summer_standard_dev_all_624$sd_2)
print(summer_sd_mk_624)

summer_sd_sens_624 <- sens.slope(summer_standard_dev_all_624$sd_2)
print(summer_sd_sens_624)

```

Winter
```{r 624 SD winter NOT CORRECTED}
winter_standard_dev_all_624 <- standard_dev_624 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_624 <- winter_standard_dev_all_624 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_624 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_624, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 624 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 624 (non-corrected)

```{r 624 sd winter mk & ss non corrected}

winter_sd_mk_624 <- mk.test(winter_standard_dev_all_624$sd_2)
print(winter_sd_mk_624)

winter_sd_sens_624 <- sens.slope(winter_standard_dev_all_624$sd_2)
print(winter_sd_sens_624)

```



### Summer and Winter SD CORRECTED

Summer
```{r 624 SD Summer}
summer_standard_dev_all_624_ad <- standard_dev_624_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_624_ad <- summer_standard_dev_all_624_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_624_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_624_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 624 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 624 (corrected)

```{r 624 summer sd mk & ss adjusted}
summer_sd_mk_624_ad <- mk.test(summer_standard_dev_all_624_ad$sd_2)
print(summer_sd_mk_624_ad)

summer_sd_sens_624_ad <- sens.slope(summer_standard_dev_all_624_ad$sd_2)
print(summer_sd_sens_624_ad)

```

Winter
```{r 624 SD winter}
winter_standard_dev_all_624_ad <- standard_dev_624_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_624_ad <- winter_standard_dev_all_624_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_624_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_624_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 624 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 624 (corrected)

```{r 624 winter sd mk & ss adjusted}
winter_sd_mk_624_ad <- mk.test(winter_standard_dev_all_624_ad$sd_2)
print(winter_sd_mk_624_ad)

winter_sd_sens_624_ad <- sens.slope(winter_standard_dev_all_624_ad$sd_2)
print(winter_sd_sens_624_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 624 SD spring NOT CORRECTED}
spring_standard_dev_all_624 <- standard_dev_624 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_624 <- spring_standard_dev_all_624 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_624 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_624, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 624 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 624 (non-corrected)

```{r 624 sd spring mk & ss non corrected}

spring_sd_mk_624 <- mk.test(spring_standard_dev_all_624$sd_2)
print(spring_sd_mk_624)

spring_sd_sens_624 <- sens.slope(spring_standard_dev_all_624$sd_2)
print(spring_sd_sens_624)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 624 SD fall NOT CORRECTED}
fall_standard_dev_all_624 <- standard_dev_624 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_624 <- fall_standard_dev_all_624 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_624 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_624, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 624 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 624 (non-corrected)

```{r 624 sd fall mk & ss non corrected}

fall_sd_mk_624 <- mk.test(fall_standard_dev_all_624$sd_2)
print(fall_sd_mk_624)

fall_sd_sens_624 <- sens.slope(fall_standard_dev_all_624$sd_2)
print(fall_sd_sens_624)

```



### Spring and Fall SD CORRECTED

Spring
```{r 624 SD Spring}
spring_standard_dev_all_624_ad <- standard_dev_624_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_624_ad <- spring_standard_dev_all_624_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_624_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_624_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 624 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 624 (corrected)

```{r 624 spring sd mk & ss adjusted}
spring_sd_mk_624_ad <- mk.test(spring_standard_dev_all_624_ad$sd_2)
print(spring_sd_mk_624_ad)

spring_sd_sens_624_ad <- sens.slope(spring_standard_dev_all_624_ad$sd_2)
print(spring_sd_sens_624_ad)

```

Fall
```{r 624 SD fall}
fall_standard_dev_all_624_ad <- standard_dev_624_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_624_ad <- fall_standard_dev_all_624_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_624_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_624_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 624 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 624 (corrected)

```{r 624 fall sd mk & ss adjusted}
fall_sd_mk_624_ad <- mk.test(fall_standard_dev_all_624_ad$sd_2)
print(fall_sd_mk_624_ad)

fall_sd_sens_624_ad <- sens.slope(fall_standard_dev_all_624_ad$sd_2)
print(fall_sd_sens_624_ad)

```



# Molas Lake	632 
*NSCE-Morrisey, Bias-Original*  10/2/2003

```{r filter Molas Lake (632) station}

snotel_632 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "632")

```

```{r 632 clean & water year & day }
#str(snotel_632) # check the date, usually a character.  

snotel_632$Date <- as.Date(snotel_632$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_632_clean <- snotel_632 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_632_clean <- snotel_632_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 632 plot check }

# Check for outliers

ggplot(snotel_632_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 632 trying to clean outliers}



snotel_632_clean <- snotel_632_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  #filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 25)

```


```{r 632 temp difference}

ggplot(snotel_632_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 632 cull selection}

# filtering for temperature anomalies
snotel_632_cull_count <- snotel_632_clean %>% 
  filter(temperature_min > -40) %>% 
  count(waterYear)

snotel_632_cull_count

# filtering for too few observations in a year
snotel_632_cull_count_days <- snotel_632_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_632_cull_count_days

```

1986, 1993, 1994, 2005, 2006, 2013 need to be culled.

```{r 632 cull}

snotel_632_clean_culled <- snotel_632_clean %>% 
  filter(waterYear != "1986" & waterYear != "1993" & waterYear != "1994" & waterYear != "2005" & waterYear != "2006" & waterYear != "2013")# & waterYear != "1993" & waterYear != "1994" & waterYear != "2021" & waterYear != "2022") & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_632_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 632 culled plot}

ggplot(snotel_632_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_632_xts <- xts(snotel_632_clean_culled$temperature_mean, order.by = snotel_632_clean_culled$Date)

dygraph(temp_632_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

snotel_632_clean_culled <- snotel_632_clean_culled %>% 
  filter(temperature_mean < 20)

temp_632_xts <- xts(snotel_632_clean_culled$temperature_mean, order.by = snotel_632_clean_culled$Date)

dygraph(temp_632_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Molas Lake 632 
*NSCE-Morrisey, Bias-Original*  10/2/2003

```{r 632 adj}

snotel_632_adjusted <- snotel_632_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2003-10-02", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 632 Detrended

```{r 632 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_632 <- snotel_632_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_632 <- yearly_wy_aver_632 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_632 <- daily_wy_aver_632 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_632$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_632 <-daily_wy_aver_632 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_632$date_temp <- signif(daily_wy_aver2_632$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_632, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 632 SD 

```{r 632 SD}

standard_dev_632 <- daily_wy_aver_632 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_632 <- standard_dev_632 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_632 <- standard_dev_all_632 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_632 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_632, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 632 average temperatures for water years 2005-2021* 


#### MK & SS for 632 (non-corrected)

```{r 632 sd mk & ss non corrected}

sd_mk_632 <- mk.test(standard_dev_all_632$sd_2)
print(sd_mk_632)

sd_sens_632 <- sens.slope(standard_dev_all_632$sd_2)
print(sd_sens_632)

```

#### Corrected


#### 632 Detrended (corrected)

```{r 632 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_632_ad <- snotel_632_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_632_ad <- yearly_wy_aver_632_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_632_ad <- daily_wy_aver_632_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_632_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_632_ad <-daily_wy_aver_632_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_632_ad$date_temp_ad <- signif(daily_wy_aver2_632_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_632_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 632 SS (corrected)

```{r 632 SD adjusted}
standard_dev_632_ad <- daily_wy_aver_632_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_632_ad <- standard_dev_632_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_632_ad <- standard_dev_all_632_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_632_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_632_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 632 average temperatures for water years 1986-2021* 


#### MK & SS 632 (corrected)

```{r 632 sd mk & ss adjusted}
sd_mk_632_ad <- mk.test(standard_dev_all_632_ad$sd_2)
print(sd_mk_632_ad)

sd_sens_632_ad <- sens.slope(standard_dev_all_632_ad$sd_2)
print(sd_sens_632_ad)

```



### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 632 SD summer NOT CORRECTED}
summer_standard_dev_all_632 <- standard_dev_632 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_632 <- summer_standard_dev_all_632 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_632 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_632, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 632 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 632 (non-corrected)

```{r 632 sd summer mk & ss non corrected}

summer_sd_mk_632 <- mk.test(summer_standard_dev_all_632$sd_2)
print(summer_sd_mk_632)

summer_sd_sens_632 <- sens.slope(summer_standard_dev_all_632$sd_2)
print(summer_sd_sens_632)

```

Winter
```{r 632 SD winter NOT CORRECTED}
winter_standard_dev_all_632 <- standard_dev_632 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_632 <- winter_standard_dev_all_632 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_632 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_632, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 632 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 632 (non-corrected)

```{r 632 sd winter mk & ss non corrected}

winter_sd_mk_632 <- mk.test(winter_standard_dev_all_632$sd_2)
print(winter_sd_mk_632)

winter_sd_sens_632 <- sens.slope(winter_standard_dev_all_632$sd_2)
print(winter_sd_sens_632)

```



### Summer and Winter SD CORRECTED

Summer
```{r 632 SD Summer}
summer_standard_dev_all_632_ad <- standard_dev_632_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_632_ad <- summer_standard_dev_all_632_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_632_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_632_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 632 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 632 (corrected)

```{r 632 summer sd mk & ss adjusted}
summer_sd_mk_632_ad <- mk.test(summer_standard_dev_all_632_ad$sd_2)
print(summer_sd_mk_632_ad)

summer_sd_sens_632_ad <- sens.slope(summer_standard_dev_all_632_ad$sd_2)
print(summer_sd_sens_632_ad)

```

Winter
```{r 632 SD winter}
winter_standard_dev_all_632_ad <- standard_dev_632_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_632_ad <- winter_standard_dev_all_632_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_632_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_632_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 632 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 632 (corrected)

```{r 632 winter sd mk & ss adjusted}
winter_sd_mk_632_ad <- mk.test(winter_standard_dev_all_632_ad$sd_2)
print(winter_sd_mk_632_ad)

winter_sd_sens_632_ad <- sens.slope(winter_standard_dev_all_632_ad$sd_2)
print(winter_sd_sens_632_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 632 SD spring NOT CORRECTED}
spring_standard_dev_all_632 <- standard_dev_632 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_632 <- spring_standard_dev_all_632 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_632 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_632, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 632 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 632 (non-corrected)

```{r 632 sd spring mk & ss non corrected}

spring_sd_mk_632 <- mk.test(spring_standard_dev_all_632$sd_2)
print(spring_sd_mk_632)

spring_sd_sens_632 <- sens.slope(spring_standard_dev_all_632$sd_2)
print(spring_sd_sens_632)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 632 SD fall NOT CORRECTED}
fall_standard_dev_all_632 <- standard_dev_632 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_632 <- fall_standard_dev_all_632 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_632 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_632, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 632 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 632 (non-corrected)

```{r 632 sd fall mk & ss non corrected}

fall_sd_mk_632 <- mk.test(fall_standard_dev_all_632$sd_2)
print(fall_sd_mk_632)

fall_sd_sens_632 <- sens.slope(fall_standard_dev_all_632$sd_2)
print(fall_sd_sens_632)

```



### Spring and Fall SD CORRECTED

Spring
```{r 632 SD Spring}
spring_standard_dev_all_632_ad <- standard_dev_632_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_632_ad <- spring_standard_dev_all_632_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_632_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_632_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 632 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 632 (corrected)

```{r 632 spring sd mk & ss adjusted}
spring_sd_mk_632_ad <- mk.test(spring_standard_dev_all_632_ad$sd_2)
print(spring_sd_mk_632_ad)

spring_sd_sens_632_ad <- sens.slope(spring_standard_dev_all_632_ad$sd_2)
print(spring_sd_sens_632_ad)

```

Fall
```{r 632 SD fall}
fall_standard_dev_all_632_ad <- standard_dev_632_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_632_ad <- fall_standard_dev_all_632_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_632_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_632_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 632 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 632 (corrected)

```{r 632 fall sd mk & ss adjusted}
fall_sd_mk_632_ad <- mk.test(fall_standard_dev_all_632_ad$sd_2)
print(fall_sd_mk_632_ad)

fall_sd_sens_632_ad <- sens.slope(fall_standard_dev_all_632_ad$sd_2)
print(fall_sd_sens_632_ad)

```



# Red Mountain Pass	713 
*Morrisey* 8/18/2004

```{r filter Molas Lake (713) station}

snotel_713 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "713")

```

```{r 713 clean & water year & day }
#str(snotel_713) # check the date, usually a character.  

snotel_713$Date <- as.Date(snotel_713$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_713_clean <- snotel_713 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_713_clean <- snotel_713_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 713 plot check }

# Check for outliers

ggplot(snotel_713_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 713 trying to clean outliers}



snotel_713_clean <- snotel_713_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 25)

```


```{r 713 temp difference}

ggplot(snotel_713_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 713 cull selection}

# filtering for temperature anomalies
snotel_713_cull_count <- snotel_713_clean %>% 
  filter(temperature_min > -40) %>% 
  count(waterYear)

snotel_713_cull_count

# filtering for too few observations in a year
snotel_713_cull_count_days <- snotel_713_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_713_cull_count_days

```

1981, 1982, 1983, 1987, 1989, 1994 need to be culled. 1984 & 1985 are too low. 

```{r 713 cull}

snotel_713_clean_culled <- snotel_713_clean %>% 
  filter(waterYear > "1985" & waterYear != "1987" & waterYear != "1989" & waterYear != "1994")# & waterYear != "1993" & waterYear != "1994" & waterYear != "2021" & waterYear != "2022") & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_713_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 713 culled plot}

ggplot(snotel_713_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_713_xts <- xts(snotel_713_clean_culled$temperature_mean, order.by = snotel_713_clean_culled$Date)

dygraph(temp_713_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

snotel_713_clean_culled <- snotel_713_clean_culled %>% 
  filter(temperature_mean < 19.3)

temp_713_xts <- xts(snotel_713_clean_culled$temperature_mean, order.by = snotel_713_clean_culled$Date)

dygraph(temp_713_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Red Mountain Pass	713 
*Morrisey* 8/18/2004

```{r 713 adj}

snotel_713_adjusted <- snotel_713_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2004-08-18", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 713 Detrended

```{r 713 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_713 <- snotel_713_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_713 <- yearly_wy_aver_713 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_713 <- daily_wy_aver_713 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_713$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_713 <-daily_wy_aver_713 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_713$date_temp <- signif(daily_wy_aver2_713$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_713, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 713 SD 

```{r 713 SD}

standard_dev_713 <- daily_wy_aver_713 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_713 <- standard_dev_713 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_713 <- standard_dev_all_713 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_713 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_713, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 713 average temperatures for water years 2005-2021* 


#### MK & SS for 713 (non-corrected)

```{r 713 sd mk & ss non corrected}

sd_mk_713 <- mk.test(standard_dev_all_713$sd_2)
print(sd_mk_713)

sd_sens_713 <- sens.slope(standard_dev_all_713$sd_2)
print(sd_sens_713)

```

#### Corrected


#### 713 Detrended (corrected)

```{r 713 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_713_ad <- snotel_713_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_713_ad <- yearly_wy_aver_713_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_713_ad <- daily_wy_aver_713_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_713_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_713_ad <-daily_wy_aver_713_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_713_ad$date_temp_ad <- signif(daily_wy_aver2_713_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_713_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 713 SS (corrected)

```{r 713 SD adjusted}
standard_dev_713_ad <- daily_wy_aver_713_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_713_ad <- standard_dev_713_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_713_ad <- standard_dev_all_713_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_713_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_713_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 713 average temperatures for water years 1986-2021* 


#### MK & SS 713 (corrected)

```{r 713 sd mk & ss adjusted}
sd_mk_713_ad <- mk.test(standard_dev_all_713_ad$sd_2)
print(sd_mk_713_ad)

sd_sens_713_ad <- sens.slope(standard_dev_all_713_ad$sd_2)
print(sd_sens_713_ad)

```



### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 713 SD summer NOT CORRECTED}
summer_standard_dev_all_713 <- standard_dev_713 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_713 <- summer_standard_dev_all_713 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_713 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_713, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 713 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 713 (non-corrected)

```{r 713 sd summer mk & ss non corrected}

summer_sd_mk_713 <- mk.test(summer_standard_dev_all_713$sd_2)
print(summer_sd_mk_713)

summer_sd_sens_713 <- sens.slope(summer_standard_dev_all_713$sd_2)
print(summer_sd_sens_713)

```

Winter
```{r 713 SD winter NOT CORRECTED}
winter_standard_dev_all_713 <- standard_dev_713 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_713 <- winter_standard_dev_all_713 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_713 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_713, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 713 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 713 (non-corrected)

```{r 713 sd winter mk & ss non corrected}

winter_sd_mk_713 <- mk.test(winter_standard_dev_all_713$sd_2)
print(winter_sd_mk_713)

winter_sd_sens_713 <- sens.slope(winter_standard_dev_all_713$sd_2)
print(winter_sd_sens_713)

```



### Summer and Winter SD CORRECTED

Summer
```{r 713 SD Summer}
summer_standard_dev_all_713_ad <- standard_dev_713_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_713_ad <- summer_standard_dev_all_713_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_713_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_713_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 713 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 713 (corrected)

```{r 713 summer sd mk & ss adjusted}
summer_sd_mk_713_ad <- mk.test(summer_standard_dev_all_713_ad$sd_2)
print(summer_sd_mk_713_ad)

summer_sd_sens_713_ad <- sens.slope(summer_standard_dev_all_713_ad$sd_2)
print(summer_sd_sens_713_ad)

```

Winter
```{r 713 SD winter}
winter_standard_dev_all_713_ad <- standard_dev_713_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_713_ad <- winter_standard_dev_all_713_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_713_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_713_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 713 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 713 (corrected)

```{r 713 winter sd mk & ss adjusted}
winter_sd_mk_713_ad <- mk.test(winter_standard_dev_all_713_ad$sd_2)
print(winter_sd_mk_713_ad)

winter_sd_sens_713_ad <- sens.slope(winter_standard_dev_all_713_ad$sd_2)
print(winter_sd_sens_713_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 713 SD spring NOT CORRECTED}
spring_standard_dev_all_713 <- standard_dev_713 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_713 <- spring_standard_dev_all_713 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_713 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_713, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 713 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 713 (non-corrected)

```{r 713 sd spring mk & ss non corrected}

spring_sd_mk_713 <- mk.test(spring_standard_dev_all_713$sd_2)
print(spring_sd_mk_713)

spring_sd_sens_713 <- sens.slope(spring_standard_dev_all_713$sd_2)
print(spring_sd_sens_713)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 713 SD fall NOT CORRECTED}
fall_standard_dev_all_713 <- standard_dev_713 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_713 <- fall_standard_dev_all_713 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_713 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_713, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 713 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 713 (non-corrected)

```{r 713 sd fall mk & ss non corrected}

fall_sd_mk_713 <- mk.test(fall_standard_dev_all_713$sd_2)
print(fall_sd_mk_713)

fall_sd_sens_713 <- sens.slope(fall_standard_dev_all_713$sd_2)
print(fall_sd_sens_713)

```



### Spring and Fall SD CORRECTED

Spring
```{r 713 SD Spring}
spring_standard_dev_all_713_ad <- standard_dev_713_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_713_ad <- spring_standard_dev_all_713_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_713_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_713_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 713 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 713 (corrected)

```{r 713 spring sd mk & ss adjusted}
spring_sd_mk_713_ad <- mk.test(spring_standard_dev_all_713_ad$sd_2)
print(spring_sd_mk_713_ad)

spring_sd_sens_713_ad <- sens.slope(spring_standard_dev_all_713_ad$sd_2)
print(spring_sd_sens_713_ad)

```

Fall
```{r 713 SD fall}
fall_standard_dev_all_713_ad <- standard_dev_713_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_713_ad <- fall_standard_dev_all_713_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_713_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_713_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 713 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 713 (corrected)

```{r 713 fall sd mk & ss adjusted}
fall_sd_mk_713_ad <- mk.test(fall_standard_dev_all_713_ad$sd_2)
print(fall_sd_mk_713_ad)

fall_sd_sens_713_ad <- sens.slope(fall_standard_dev_all_713_ad$sd_2)
print(fall_sd_sens_713_ad)

```



# Scotch Creek 739 
*Morrisey* 6/15/2004

```{r filter Molas Lake (739) station}

snotel_739 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "739")

```

```{r 739 clean & water year & day }
#str(snotel_739) # check the date, usually a character.  

snotel_739$Date <- as.Date(snotel_739$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_739_clean <- snotel_739 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_739_clean <- snotel_739_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 739 plot check }

# Check for outliers

ggplot(snotel_739_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 739 trying to clean outliers}



snotel_739_clean <- snotel_739_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 25)

```


```{r 739 temp difference}

ggplot(snotel_739_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 739 cull selection}

# filtering for temperature anomalies
snotel_739_cull_count <- snotel_739_clean %>% 
  filter(temperature_min > -40) %>% 
  count(waterYear)

snotel_739_cull_count

# filtering for too few observations in a year
snotel_739_cull_count_days <- snotel_739_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_739_cull_count_days

```

1987, 1988, 1993, 1994, 2016, 2017 need to be culled.

```{r 739 cull}

snotel_739_clean_culled <- snotel_739_clean %>% 
  filter(waterYear != "1987" & waterYear != "1988" & waterYear != "1993" & waterYear != "1994" & waterYear != "2016" & waterYear != "2017")# & waterYear != "1993" & waterYear != "1994" & waterYear != "2021" & waterYear != "2022") & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_739_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 739 culled plot}

ggplot(snotel_739_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_739_xts <- xts(snotel_739_clean_culled$temperature_mean, order.by = snotel_739_clean_culled$Date)

dygraph(temp_739_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

snotel_739_clean_culled <- snotel_739_clean_culled %>% 
  filter(temperature_mean < 19.3)

temp_739_xts <- xts(snotel_739_clean_culled$temperature_mean, order.by = snotel_739_clean_culled$Date)

dygraph(temp_739_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Scotch Creek 739 
*Morrisey* 6/15/2004

```{r 739 adj}

snotel_739_adjusted <- snotel_739_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2004-06-15", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 739 Detrended

```{r 739 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_739 <- snotel_739_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_739 <- yearly_wy_aver_739 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_739 <- daily_wy_aver_739 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_739$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_739 <-daily_wy_aver_739 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_739$date_temp <- signif(daily_wy_aver2_739$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_739, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 739 SD 

```{r 739 SD}

standard_dev_739 <- daily_wy_aver_739 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_739 <- standard_dev_739 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_739 <- standard_dev_all_739 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_739 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_739, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 739 average temperatures for water years 2005-2021* 


#### MK & SS for 739 (non-corrected)

```{r 739 sd mk & ss non corrected}

sd_mk_739 <- mk.test(standard_dev_all_739$sd_2)
print(sd_mk_739)

sd_sens_739 <- sens.slope(standard_dev_all_739$sd_2)
print(sd_sens_739)

```

#### Corrected


#### 739 Detrended (corrected)

```{r 739 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_739_ad <- snotel_739_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_739_ad <- yearly_wy_aver_739_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_739_ad <- daily_wy_aver_739_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_739_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_739_ad <-daily_wy_aver_739_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_739_ad$date_temp_ad <- signif(daily_wy_aver2_739_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_739_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 739 SS (corrected)

```{r 739 SD adjusted}
standard_dev_739_ad <- daily_wy_aver_739_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_739_ad <- standard_dev_739_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_739_ad <- standard_dev_all_739_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_739_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_739_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 739 average temperatures for water years 1986-2021* 


#### MK & SS 739 (corrected)

```{r 739 sd mk & ss adjusted}
sd_mk_739_ad <- mk.test(standard_dev_all_739_ad$sd_2)
print(sd_mk_739_ad)

sd_sens_739_ad <- sens.slope(standard_dev_all_739_ad$sd_2)
print(sd_sens_739_ad)

```



### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 739 SD summer NOT CORRECTED}
summer_standard_dev_all_739 <- standard_dev_739 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_739 <- summer_standard_dev_all_739 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_739 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_739, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 739 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 739 (non-corrected)

```{r 739 sd summer mk & ss non corrected}

summer_sd_mk_739 <- mk.test(summer_standard_dev_all_739$sd_2)
print(summer_sd_mk_739)

summer_sd_sens_739 <- sens.slope(summer_standard_dev_all_739$sd_2)
print(summer_sd_sens_739)

```

Winter
```{r 739 SD winter NOT CORRECTED}
winter_standard_dev_all_739 <- standard_dev_739 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_739 <- winter_standard_dev_all_739 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_739 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_739, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 739 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 739 (non-corrected)

```{r 739 sd winter mk & ss non corrected}

winter_sd_mk_739 <- mk.test(winter_standard_dev_all_739$sd_2)
print(winter_sd_mk_739)

winter_sd_sens_739 <- sens.slope(winter_standard_dev_all_739$sd_2)
print(winter_sd_sens_739)

```



### Summer and Winter SD CORRECTED

Summer
```{r 739 SD Summer}
summer_standard_dev_all_739_ad <- standard_dev_739_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_739_ad <- summer_standard_dev_all_739_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_739_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_739_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 739 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 739 (corrected)

```{r 739 summer sd mk & ss adjusted}
summer_sd_mk_739_ad <- mk.test(summer_standard_dev_all_739_ad$sd_2)
print(summer_sd_mk_739_ad)

summer_sd_sens_739_ad <- sens.slope(summer_standard_dev_all_739_ad$sd_2)
print(summer_sd_sens_739_ad)

```

Winter
```{r 739 SD winter}
winter_standard_dev_all_739_ad <- standard_dev_739_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_739_ad <- winter_standard_dev_all_739_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_739_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_739_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 739 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 739 (corrected)

```{r 739 winter sd mk & ss adjusted}
winter_sd_mk_739_ad <- mk.test(winter_standard_dev_all_739_ad$sd_2)
print(winter_sd_mk_739_ad)

winter_sd_sens_739_ad <- sens.slope(winter_standard_dev_all_739_ad$sd_2)
print(winter_sd_sens_739_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 739 SD spring NOT CORRECTED}
spring_standard_dev_all_739 <- standard_dev_739 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_739 <- spring_standard_dev_all_739 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_739 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_739, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 739 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 739 (non-corrected)

```{r 739 sd spring mk & ss non corrected}

spring_sd_mk_739 <- mk.test(spring_standard_dev_all_739$sd_2)
print(spring_sd_mk_739)

spring_sd_sens_739 <- sens.slope(spring_standard_dev_all_739$sd_2)
print(spring_sd_sens_739)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 739 SD fall NOT CORRECTED}
fall_standard_dev_all_739 <- standard_dev_739 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_739 <- fall_standard_dev_all_739 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_739 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_739, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 739 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 739 (non-corrected)

```{r 739 sd fall mk & ss non corrected}

fall_sd_mk_739 <- mk.test(fall_standard_dev_all_739$sd_2)
print(fall_sd_mk_739)

fall_sd_sens_739 <- sens.slope(fall_standard_dev_all_739$sd_2)
print(fall_sd_sens_739)

```



### Spring and Fall SD CORRECTED

Spring
```{r 739 SD Spring}
spring_standard_dev_all_739_ad <- standard_dev_739_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_739_ad <- spring_standard_dev_all_739_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_739_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_739_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 739 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 739 (corrected)

```{r 739 spring sd mk & ss adjusted}
spring_sd_mk_739_ad <- mk.test(spring_standard_dev_all_739_ad$sd_2)
print(spring_sd_mk_739_ad)

spring_sd_sens_739_ad <- sens.slope(spring_standard_dev_all_739_ad$sd_2)
print(spring_sd_sens_739_ad)

```

Fall
```{r 739 SD fall}
fall_standard_dev_all_739_ad <- standard_dev_739_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_739_ad <- fall_standard_dev_all_739_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_739_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_739_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 739 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 739 (corrected)

```{r 739 fall sd mk & ss adjusted}
fall_sd_mk_739_ad <- mk.test(fall_standard_dev_all_739_ad$sd_2)
print(fall_sd_mk_739_ad)

fall_sd_sens_739_ad <- sens.slope(fall_standard_dev_all_739_ad$sd_2)
print(fall_sd_sens_739_ad)

```



# Slumgullion	762 
*Morrisey* 6/26/2006

```{r filter (762) station}

snotel_762 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "762")

```

```{r 762 clean & water year & day }
#str(snotel_762) # check the date, usually a character.  

snotel_762$Date <- as.Date(snotel_762$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_762_clean <- snotel_762 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_762_clean <- snotel_762_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 762 plot check }

# Check for outliers

ggplot(snotel_762_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 762 trying to clean outliers}



snotel_762_clean <- snotel_762_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 25)

```


```{r 762 temp difference}

ggplot(snotel_762_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 762 cull selection}

# filtering for temperature anomalies
#snotel_762_cull_count <- snotel_762_clean %>% 
#  filter(temperature_min > -40) %>% 
#  count(waterYear)

#snotel_762_cull_count

# filtering for too few observations in a year
snotel_762_cull_count_days <- snotel_762_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_762_cull_count_days

```

1980, 1982, 1994, 2003 need to be culled. 1995 maximums are less than the minimums.

```{r 762 cull}

snotel_762_clean_culled <- snotel_762_clean %>% 
  filter(waterYear != "1980" & waterYear != "1981" & waterYear != "1982" & waterYear != "1983" & waterYear != "1994" & waterYear != "1995" & waterYear != "2003")# & waterYear != "2017" & waterYear != "1993" & waterYear != "1994" & waterYear != "2021" & waterYear != "2022") & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_762_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 762 culled plot}

ggplot(snotel_762_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_762_xts <- xts(snotel_762_clean_culled$temperature_mean, order.by = snotel_762_clean_culled$Date)

dygraph(temp_762_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

#snotel_762_clean_culled <- snotel_762_clean_culled %>% 
#  filter(temperature_mean < 19.3)

temp_762_xts <- xts(snotel_762_clean_culled$temperature_mean, order.by = snotel_762_clean_culled$Date)

dygraph(temp_762_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Slumgullion	762 
*Morrisey* 6/26/2006

```{r 762 adj}

snotel_762_adjusted <- snotel_762_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2006-06-26", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 762 Detrended

```{r 762 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_762 <- snotel_762_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_762 <- yearly_wy_aver_762 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_762 <- daily_wy_aver_762 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_762$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_762 <-daily_wy_aver_762 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_762$date_temp <- signif(daily_wy_aver2_762$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_762, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 762 SD 

```{r 762 SD}

standard_dev_762 <- daily_wy_aver_762 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_762 <- standard_dev_762 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_762 <- standard_dev_all_762 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_762 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_762, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 762 average temperatures for water years 2005-2021* 


#### MK & SS for 762 (non-corrected)

```{r 762 sd mk & ss non corrected}

sd_mk_762 <- mk.test(standard_dev_all_762$sd_2)
print(sd_mk_762)

sd_sens_762 <- sens.slope(standard_dev_all_762$sd_2)
print(sd_sens_762)

```

#### Corrected


#### 762 Detrended (corrected)

```{r 762 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_762_ad <- snotel_762_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_762_ad <- yearly_wy_aver_762_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_762_ad <- daily_wy_aver_762_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_762_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_762_ad <-daily_wy_aver_762_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_762_ad$date_temp_ad <- signif(daily_wy_aver2_762_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_762_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 762 SS (corrected)

```{r 762 SD adjusted}
standard_dev_762_ad <- daily_wy_aver_762_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_762_ad <- standard_dev_762_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_762_ad <- standard_dev_all_762_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_762_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_762_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 762 average temperatures for water years 1986-2021* 


#### MK & SS 762 (corrected)

```{r 762 sd mk & ss adjusted}
sd_mk_762_ad <- mk.test(standard_dev_all_762_ad$sd_2)
print(sd_mk_762_ad)

sd_sens_762_ad <- sens.slope(standard_dev_all_762_ad$sd_2)
print(sd_sens_762_ad)

```




### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 762 SD summer NOT CORRECTED}
summer_standard_dev_all_762 <- standard_dev_762 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_762 <- summer_standard_dev_all_762 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_762 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_762, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 762 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 762 (non-corrected)

```{r 762 sd summer mk & ss non corrected}

summer_sd_mk_762 <- mk.test(summer_standard_dev_all_762$sd_2)
print(summer_sd_mk_762)

summer_sd_sens_762 <- sens.slope(summer_standard_dev_all_762$sd_2)
print(summer_sd_sens_762)

```

Winter
```{r 762 SD winter NOT CORRECTED}
winter_standard_dev_all_762 <- standard_dev_762 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_762 <- winter_standard_dev_all_762 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_762 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_762, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 762 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 762 (non-corrected)

```{r 762 sd winter mk & ss non corrected}

winter_sd_mk_762 <- mk.test(winter_standard_dev_all_762$sd_2)
print(winter_sd_mk_762)

winter_sd_sens_762 <- sens.slope(winter_standard_dev_all_762$sd_2)
print(winter_sd_sens_762)

```



### Summer and Winter SD CORRECTED

Summer
```{r 762 SD Summer}
summer_standard_dev_all_762_ad <- standard_dev_762_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_762_ad <- summer_standard_dev_all_762_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_762_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_762_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 762 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 762 (corrected)

```{r 762 summer sd mk & ss adjusted}
summer_sd_mk_762_ad <- mk.test(summer_standard_dev_all_762_ad$sd_2)
print(summer_sd_mk_762_ad)

summer_sd_sens_762_ad <- sens.slope(summer_standard_dev_all_762_ad$sd_2)
print(summer_sd_sens_762_ad)

```

Winter
```{r 762 SD winter}
winter_standard_dev_all_762_ad <- standard_dev_762_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_762_ad <- winter_standard_dev_all_762_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_762_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_762_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 762 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 762 (corrected)

```{r 762 winter sd mk & ss adjusted}
winter_sd_mk_762_ad <- mk.test(winter_standard_dev_all_762_ad$sd_2)
print(winter_sd_mk_762_ad)

winter_sd_sens_762_ad <- sens.slope(winter_standard_dev_all_762_ad$sd_2)
print(winter_sd_sens_762_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 762 SD spring NOT CORRECTED}
spring_standard_dev_all_762 <- standard_dev_762 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_762 <- spring_standard_dev_all_762 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_762 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_762, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 762 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 762 (non-corrected)

```{r 762 sd spring mk & ss non corrected}

spring_sd_mk_762 <- mk.test(spring_standard_dev_all_762$sd_2)
print(spring_sd_mk_762)

spring_sd_sens_762 <- sens.slope(spring_standard_dev_all_762$sd_2)
print(spring_sd_sens_762)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 762 SD fall NOT CORRECTED}
fall_standard_dev_all_762 <- standard_dev_762 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_762 <- fall_standard_dev_all_762 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_762 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_762, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 762 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 762 (non-corrected)

```{r 762 sd fall mk & ss non corrected}

fall_sd_mk_762 <- mk.test(fall_standard_dev_all_762$sd_2)
print(fall_sd_mk_762)

fall_sd_sens_762 <- sens.slope(fall_standard_dev_all_762$sd_2)
print(fall_sd_sens_762)

```



### Spring and Fall SD CORRECTED

Spring
```{r 762 SD Spring}
spring_standard_dev_all_762_ad <- standard_dev_762_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_762_ad <- spring_standard_dev_all_762_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_762_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_762_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 762 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 762 (corrected)

```{r 762 spring sd mk & ss adjusted}
spring_sd_mk_762_ad <- mk.test(spring_standard_dev_all_762_ad$sd_2)
print(spring_sd_mk_762_ad)

spring_sd_sens_762_ad <- sens.slope(spring_standard_dev_all_762_ad$sd_2)
print(spring_sd_sens_762_ad)

```

Fall
```{r 762 SD fall}
fall_standard_dev_all_762_ad <- standard_dev_762_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_762_ad <- fall_standard_dev_all_762_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_762_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_762_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 762 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 762 (corrected)

```{r 762 fall sd mk & ss adjusted}
fall_sd_mk_762_ad <- mk.test(fall_standard_dev_all_762_ad$sd_2)
print(fall_sd_mk_762_ad)

fall_sd_sens_762_ad <- sens.slope(fall_standard_dev_all_762_ad$sd_2)
print(fall_sd_sens_762_ad)

```



# Spud Mountain	780 
*Morrisey* 6/28/2004

```{r filter (780) station}

snotel_780 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "780")

```

```{r 780 clean & water year & day }
#str(snotel_780) # check the date, usually a character.  

snotel_780$Date <- as.Date(snotel_780$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_780_clean <- snotel_780 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_780_clean <- snotel_780_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 780 plot check }

# Check for outliers

ggplot(snotel_780_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 780 trying to clean outliers}



snotel_780_clean <- snotel_780_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 25)

```


```{r 780 temp difference}

ggplot(snotel_780_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 780 cull selection}

# filtering for temperature anomalies
#snotel_780_cull_count <- snotel_780_clean %>% 
#  filter(temperature_min > -40) %>% 
#  count(waterYear)

#snotel_780_cull_count

# filtering for too few observations in a year
snotel_780_cull_count_days <- snotel_780_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_780_cull_count_days

```

1987, 1994, 1998, 2009, 2011, 2013, 2016, 2017 need to be culled. 

```{r 780 cull}

snotel_780_clean_culled <- snotel_780_clean %>% 
  filter(waterYear != "1987" & waterYear != "1994" & waterYear != "1998" & waterYear != "2009" & waterYear != "2011" & waterYear != "2013" & waterYear != "2016" & waterYear != "2017")# & waterYear != "1993" & waterYear != "1994" & waterYear != "2021" & waterYear != "2022") & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_780_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 780 culled plot}

ggplot(snotel_780_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_780_xts <- xts(snotel_780_clean_culled$temperature_mean, order.by = snotel_780_clean_culled$Date)

dygraph(temp_780_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

#snotel_780_clean_culled <- snotel_780_clean_culled %>% 
#  filter(temperature_mean < 19.3)

temp_780_xts <- xts(snotel_780_clean_culled$temperature_mean, order.by = snotel_780_clean_culled$Date)

dygraph(temp_780_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Spud Mountain	780 
*Morrisey* 6/28/2004

```{r 780 adj}

snotel_780_adjusted <- snotel_780_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2004-06-28", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 780 Detrended

```{r 780 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_780 <- snotel_780_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_780 <- yearly_wy_aver_780 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_780 <- daily_wy_aver_780 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_780$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_780 <-daily_wy_aver_780 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_780$date_temp <- signif(daily_wy_aver2_780$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_780, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 780 SD 

```{r 780 SD}

standard_dev_780 <- daily_wy_aver_780 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_780 <- standard_dev_780 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_780 <- standard_dev_all_780 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_780 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_780, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 780 average temperatures for water years 2005-2021* 


#### MK & SS for 780 (non-corrected)

```{r 780 sd mk & ss non corrected}

sd_mk_780 <- mk.test(standard_dev_all_780$sd_2)
print(sd_mk_780)

sd_sens_780 <- sens.slope(standard_dev_all_780$sd_2)
print(sd_sens_780)

```

#### Corrected


#### 780 Detrended (corrected)

```{r 780 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_780_ad <- snotel_780_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_780_ad <- yearly_wy_aver_780_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_780_ad <- daily_wy_aver_780_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_780_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_780_ad <-daily_wy_aver_780_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_780_ad$date_temp_ad <- signif(daily_wy_aver2_780_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_780_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 780 SS (corrected)

```{r 780 SD adjusted}
standard_dev_780_ad <- daily_wy_aver_780_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_780_ad <- standard_dev_780_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_780_ad <- standard_dev_all_780_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_780_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_780_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 780 average temperatures for water years 1986-2021* 


#### MK & SS 780 (corrected)

```{r 780 sd mk & ss adjusted}
sd_mk_780_ad <- mk.test(standard_dev_all_780_ad$sd_2)
print(sd_mk_780_ad)

sd_sens_780_ad <- sens.slope(standard_dev_all_780_ad$sd_2)
print(sd_sens_780_ad)

```



### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 780 SD summer NOT CORRECTED}
summer_standard_dev_all_780 <- standard_dev_780 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_780 <- summer_standard_dev_all_780 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_780 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_780, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 780 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 780 (non-corrected)

```{r 780 sd summer mk & ss non corrected}

summer_sd_mk_780 <- mk.test(summer_standard_dev_all_780$sd_2)
print(summer_sd_mk_780)

summer_sd_sens_780 <- sens.slope(summer_standard_dev_all_780$sd_2)
print(summer_sd_sens_780)

```

Winter
```{r 780 SD winter NOT CORRECTED}
winter_standard_dev_all_780 <- standard_dev_780 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_780 <- winter_standard_dev_all_780 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_780 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_780, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 780 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 780 (non-corrected)

```{r 780 sd winter mk & ss non corrected}

winter_sd_mk_780 <- mk.test(winter_standard_dev_all_780$sd_2)
print(winter_sd_mk_780)

winter_sd_sens_780 <- sens.slope(winter_standard_dev_all_780$sd_2)
print(winter_sd_sens_780)

```



### Summer and Winter SD CORRECTED

Summer
```{r 780 SD Summer}
summer_standard_dev_all_780_ad <- standard_dev_780_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_780_ad <- summer_standard_dev_all_780_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_780_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_780_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 780 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 780 (corrected)

```{r 780 summer sd mk & ss adjusted}
summer_sd_mk_780_ad <- mk.test(summer_standard_dev_all_780_ad$sd_2)
print(summer_sd_mk_780_ad)

summer_sd_sens_780_ad <- sens.slope(summer_standard_dev_all_780_ad$sd_2)
print(summer_sd_sens_780_ad)

```

Winter
```{r 780 SD winter}
winter_standard_dev_all_780_ad <- standard_dev_780_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_780_ad <- winter_standard_dev_all_780_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_780_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_780_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 780 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 780 (corrected)

```{r 780 winter sd mk & ss adjusted}
winter_sd_mk_780_ad <- mk.test(winter_standard_dev_all_780_ad$sd_2)
print(winter_sd_mk_780_ad)

winter_sd_sens_780_ad <- sens.slope(winter_standard_dev_all_780_ad$sd_2)
print(winter_sd_sens_780_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 780 SD spring NOT CORRECTED}
spring_standard_dev_all_780 <- standard_dev_780 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_780 <- spring_standard_dev_all_780 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_780 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_780, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 780 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 780 (non-corrected)

```{r 780 sd spring mk & ss non corrected}

spring_sd_mk_780 <- mk.test(spring_standard_dev_all_780$sd_2)
print(spring_sd_mk_780)

spring_sd_sens_780 <- sens.slope(spring_standard_dev_all_780$sd_2)
print(spring_sd_sens_780)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 780 SD fall NOT CORRECTED}
fall_standard_dev_all_780 <- standard_dev_780 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_780 <- fall_standard_dev_all_780 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_780 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_780, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 780 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 780 (non-corrected)

```{r 780 sd fall mk & ss non corrected}

fall_sd_mk_780 <- mk.test(fall_standard_dev_all_780$sd_2)
print(fall_sd_mk_780)

fall_sd_sens_780 <- sens.slope(fall_standard_dev_all_780$sd_2)
print(fall_sd_sens_780)

```



### Spring and Fall SD CORRECTED

Spring
```{r 780 SD Spring}
spring_standard_dev_all_780_ad <- standard_dev_780_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_780_ad <- spring_standard_dev_all_780_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_780_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_780_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 780 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 780 (corrected)

```{r 780 spring sd mk & ss adjusted}
spring_sd_mk_780_ad <- mk.test(spring_standard_dev_all_780_ad$sd_2)
print(spring_sd_mk_780_ad)

spring_sd_sens_780_ad <- sens.slope(spring_standard_dev_all_780_ad$sd_2)
print(spring_sd_sens_780_ad)

```

Fall
```{r 780 SD fall}
fall_standard_dev_all_780_ad <- standard_dev_780_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_780_ad <- fall_standard_dev_all_780_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_780_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_780_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 780 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 780 (corrected)

```{r 780 fall sd mk & ss adjusted}
fall_sd_mk_780_ad <- mk.test(fall_standard_dev_all_780_ad$sd_2)
print(fall_sd_mk_780_ad)

fall_sd_sens_780_ad <- sens.slope(fall_standard_dev_all_780_ad$sd_2)
print(fall_sd_sens_780_ad)

```



# Stump Lakes	797 
*Morrisey* 7/22/2005

```{r filter (797) station}

snotel_797 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "797")

```

```{r 797 clean & water year & day }
#str(snotel_797) # check the date, usually a character.  

snotel_797$Date <- as.Date(snotel_797$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_797_clean <- snotel_797 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_797_clean <- snotel_797_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 797 plot check }

# Check for outliers

ggplot(snotel_797_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 797 trying to clean outliers}



snotel_797_clean <- snotel_797_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 40)

```


```{r 797 temp difference}

ggplot(snotel_797_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 797 cull selection}

# filtering for temperature anomalies
#snotel_797_cull_count <- snotel_797_clean %>% 
#  filter(temperature_min > -40) %>% 
#  count(waterYear)

#snotel_797_cull_count

# filtering for too few observations in a year
snotel_797_cull_count_days <- snotel_797_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_797_cull_count_days

```

1987, 1993, 1994, 2005, 2006 need to be culled. 

```{r 797 cull}

snotel_797_clean_culled <- snotel_797_clean %>% 
  filter(waterYear != "1994" & waterYear != "2005" & waterYear != "2006" & waterYear != "1993" & waterYear != "1987")# & waterYear != "2021" & waterYear != "2022") & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_797_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 797 culled plot}

ggplot(snotel_797_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_797_xts <- xts(snotel_797_clean_culled$temperature_mean, order.by = snotel_797_clean_culled$Date)

dygraph(temp_797_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

#snotel_797_clean_culled <- snotel_797_clean_culled %>% 
#  filter(temperature_mean < 19.3)

temp_797_xts <- xts(snotel_797_clean_culled$temperature_mean, order.by = snotel_797_clean_culled$Date)

dygraph(temp_797_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Stump Lakes	797 
*Morrisey* 7/22/2005

```{r 797 adj}

snotel_797_adjusted <- snotel_797_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2005-07-22", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 797 Detrended

```{r 797 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_797 <- snotel_797_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_797 <- yearly_wy_aver_797 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_797 <- daily_wy_aver_797 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_797$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_797 <-daily_wy_aver_797 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_797$date_temp <- signif(daily_wy_aver2_797$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_797, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 797 SD 

```{r 797 SD}

standard_dev_797 <- daily_wy_aver_797 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_797 <- standard_dev_797 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_797 <- standard_dev_all_797 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_797 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_797, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 797 average temperatures for water years 2005-2021* 


#### MK & SS for 797 (non-corrected)

```{r 797 sd mk & ss non corrected}

sd_mk_797 <- mk.test(standard_dev_all_797$sd_2)
print(sd_mk_797)

sd_sens_797 <- sens.slope(standard_dev_all_797$sd_2)
print(sd_sens_797)

```

#### Corrected


#### 797 Detrended (corrected)

```{r 797 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_797_ad <- snotel_797_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_797_ad <- yearly_wy_aver_797_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_797_ad <- daily_wy_aver_797_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_797_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_797_ad <-daily_wy_aver_797_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_797_ad$date_temp_ad <- signif(daily_wy_aver2_797_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_797_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 797 SS (corrected)

```{r 797 SD adjusted}
standard_dev_797_ad <- daily_wy_aver_797_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_797_ad <- standard_dev_797_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_797_ad <- standard_dev_all_797_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_797_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_797_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 797 average temperatures for water years 1986-2021* 


#### MK & SS 797 (corrected)

```{r 797 sd mk & ss adjusted}
sd_mk_797_ad <- mk.test(standard_dev_all_797_ad$sd_2)
print(sd_mk_797_ad)

sd_sens_797_ad <- sens.slope(standard_dev_all_797_ad$sd_2)
print(sd_sens_797_ad)

```



### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 797 SD summer NOT CORRECTED}
summer_standard_dev_all_797 <- standard_dev_797 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_797 <- summer_standard_dev_all_797 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_797 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_797, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 797 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 797 (non-corrected)

```{r 797 sd summer mk & ss non corrected}

summer_sd_mk_797 <- mk.test(summer_standard_dev_all_797$sd_2)
print(summer_sd_mk_797)

summer_sd_sens_797 <- sens.slope(summer_standard_dev_all_797$sd_2)
print(summer_sd_sens_797)

```

Winter
```{r 797 SD winter NOT CORRECTED}
winter_standard_dev_all_797 <- standard_dev_797 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_797 <- winter_standard_dev_all_797 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_797 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_797, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 797 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 797 (non-corrected)

```{r 797 sd winter mk & ss non corrected}

winter_sd_mk_797 <- mk.test(winter_standard_dev_all_797$sd_2)
print(winter_sd_mk_797)

winter_sd_sens_797 <- sens.slope(winter_standard_dev_all_797$sd_2)
print(winter_sd_sens_797)

```



### Summer and Winter SD CORRECTED

Summer
```{r 797 SD Summer}
summer_standard_dev_all_797_ad <- standard_dev_797_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_797_ad <- summer_standard_dev_all_797_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_797_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_797_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 797 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 797 (corrected)

```{r 797 summer sd mk & ss adjusted}
summer_sd_mk_797_ad <- mk.test(summer_standard_dev_all_797_ad$sd_2)
print(summer_sd_mk_797_ad)

summer_sd_sens_797_ad <- sens.slope(summer_standard_dev_all_797_ad$sd_2)
print(summer_sd_sens_797_ad)

```

Winter
```{r 797 SD winter}
winter_standard_dev_all_797_ad <- standard_dev_797_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_797_ad <- winter_standard_dev_all_797_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_797_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_797_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 797 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 797 (corrected)

```{r 797 winter sd mk & ss adjusted}
winter_sd_mk_797_ad <- mk.test(winter_standard_dev_all_797_ad$sd_2)
print(winter_sd_mk_797_ad)

winter_sd_sens_797_ad <- sens.slope(winter_standard_dev_all_797_ad$sd_2)
print(winter_sd_sens_797_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 797 SD spring NOT CORRECTED}
spring_standard_dev_all_797 <- standard_dev_797 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_797 <- spring_standard_dev_all_797 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_797 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_797, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 797 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 797 (non-corrected)

```{r 797 sd spring mk & ss non corrected}

spring_sd_mk_797 <- mk.test(spring_standard_dev_all_797$sd_2)
print(spring_sd_mk_797)

spring_sd_sens_797 <- sens.slope(spring_standard_dev_all_797$sd_2)
print(spring_sd_sens_797)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 797 SD fall NOT CORRECTED}
fall_standard_dev_all_797 <- standard_dev_797 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_797 <- fall_standard_dev_all_797 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_797 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_797, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 797 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 797 (non-corrected)

```{r 797 sd fall mk & ss non corrected}

fall_sd_mk_797 <- mk.test(fall_standard_dev_all_797$sd_2)
print(fall_sd_mk_797)

fall_sd_sens_797 <- sens.slope(fall_standard_dev_all_797$sd_2)
print(fall_sd_sens_797)

```



### Spring and Fall SD CORRECTED

Spring
```{r 797 SD Spring}
spring_standard_dev_all_797_ad <- standard_dev_797_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_797_ad <- spring_standard_dev_all_797_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_797_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_797_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 797 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 797 (corrected)

```{r 797 spring sd mk & ss adjusted}
spring_sd_mk_797_ad <- mk.test(spring_standard_dev_all_797_ad$sd_2)
print(spring_sd_mk_797_ad)

spring_sd_sens_797_ad <- sens.slope(spring_standard_dev_all_797_ad$sd_2)
print(spring_sd_sens_797_ad)

```

Fall
```{r 797 SD fall}
fall_standard_dev_all_797_ad <- standard_dev_797_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_797_ad <- fall_standard_dev_all_797_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_797_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_797_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 797 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 797 (corrected)

```{r 797 fall sd mk & ss adjusted}
fall_sd_mk_797_ad <- mk.test(fall_standard_dev_all_797_ad$sd_2)
print(fall_sd_mk_797_ad)

fall_sd_sens_797_ad <- sens.slope(fall_standard_dev_all_797_ad$sd_2)
print(fall_sd_sens_797_ad)

```



# Upper Rio Grande	839 
*Oyler -> Morrisey* 5/26/2004

```{r filter (839) station}

snotel_839 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "839")

```

```{r 839 clean & water year & day }
#str(snotel_839) # check the date, usually a character.  

snotel_839$Date <- as.Date(snotel_839$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_839_clean <- snotel_839 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_839_clean <- snotel_839_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 839 plot check }

# Check for outliers

ggplot(snotel_839_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 839 trying to clean outliers}



snotel_839_clean <- snotel_839_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 25)

```


```{r 839 temp difference}

ggplot(snotel_839_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 839 cull selection}

# filtering for temperature anomalies
#snotel_839_cull_count <- snotel_839_clean %>% 
#  filter(temperature_min > -40) %>% 
#  count(waterYear)

#snotel_839_cull_count

# filtering for too few observations in a year
snotel_839_cull_count_days <- snotel_839_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_839_cull_count_days

```

1994, 2004, 2012, 2014, 2016 need to be culled. 

```{r 839 cull}

snotel_839_clean_culled <- snotel_839_clean %>% 
  filter(waterYear != "1994" & waterYear != "2004" & waterYear != "2012" & waterYear != "2014" & waterYear != "2016")# & waterYear != "2021" & waterYear != "2022") & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_839_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 839 culled plot}

ggplot(snotel_839_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_839_xts <- xts(snotel_839_clean_culled$temperature_mean, order.by = snotel_839_clean_culled$Date)

dygraph(temp_839_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

#snotel_839_clean_culled <- snotel_839_clean_culled %>% 
#  filter(temperature_mean < 19.3)

temp_839_xts <- xts(snotel_839_clean_culled$temperature_mean, order.by = snotel_839_clean_culled$Date)

dygraph(temp_839_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

### Upper Rio Grande	839 
*Oyler -> Morrisey* 5/26/2004

```{r 839 adj}

snotel_839_adjusted <- snotel_839_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2004-05-26", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 839 Detrended

```{r 839 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_839 <- snotel_839_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_839 <- yearly_wy_aver_839 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_839 <- daily_wy_aver_839 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_839$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_839 <-daily_wy_aver_839 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_839$date_temp <- signif(daily_wy_aver2_839$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_839, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 839 SD 

```{r 839 SD}

standard_dev_839 <- daily_wy_aver_839 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_839 <- standard_dev_839 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_839 <- standard_dev_all_839 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_839 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_839, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 839 average temperatures for water years 2005-2021* 


#### MK & SS for 839 (non-corrected)

```{r 839 sd mk & ss non corrected}

sd_mk_839 <- mk.test(standard_dev_all_839$sd_2)
print(sd_mk_839)

sd_sens_839 <- sens.slope(standard_dev_all_839$sd_2)
print(sd_sens_839)

```

#### Corrected


#### 839 Detrended (corrected)

```{r 839 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_839_ad <- snotel_839_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_839_ad <- yearly_wy_aver_839_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_839_ad <- daily_wy_aver_839_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_839_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_839_ad <-daily_wy_aver_839_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_839_ad$date_temp_ad <- signif(daily_wy_aver2_839_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_839_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 839 SS (corrected)

```{r 839 SD adjusted}
standard_dev_839_ad <- daily_wy_aver_839_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_839_ad <- standard_dev_839_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_839_ad <- standard_dev_all_839_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_839_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_839_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 839 average temperatures for water years 1986-2021* 


#### MK & SS 839 (corrected)

```{r 839 sd mk & ss adjusted}
sd_mk_839_ad <- mk.test(standard_dev_all_839_ad$sd_2)
print(sd_mk_839_ad)

sd_sens_839_ad <- sens.slope(standard_dev_all_839_ad$sd_2)
print(sd_sens_839_ad)

```



### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 839 SD summer NOT CORRECTED}
summer_standard_dev_all_839 <- standard_dev_839 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_839 <- summer_standard_dev_all_839 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_839 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_839, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 839 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 839 (non-corrected)

```{r 839 sd summer mk & ss non corrected}

summer_sd_mk_839 <- mk.test(summer_standard_dev_all_839$sd_2)
print(summer_sd_mk_839)

summer_sd_sens_839 <- sens.slope(summer_standard_dev_all_839$sd_2)
print(summer_sd_sens_839)

```

Winter
```{r 839 SD winter NOT CORRECTED}
winter_standard_dev_all_839 <- standard_dev_839 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_839 <- winter_standard_dev_all_839 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_839 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_839, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 839 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 839 (non-corrected)

```{r 839 sd winter mk & ss non corrected}

winter_sd_mk_839 <- mk.test(winter_standard_dev_all_839$sd_2)
print(winter_sd_mk_839)

winter_sd_sens_839 <- sens.slope(winter_standard_dev_all_839$sd_2)
print(winter_sd_sens_839)

```



### Summer and Winter SD CORRECTED

Summer
```{r 839 SD Summer}
summer_standard_dev_all_839_ad <- standard_dev_839_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_839_ad <- summer_standard_dev_all_839_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_839_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_839_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 839 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 839 (corrected)

```{r 839 summer sd mk & ss adjusted}
summer_sd_mk_839_ad <- mk.test(summer_standard_dev_all_839_ad$sd_2)
print(summer_sd_mk_839_ad)

summer_sd_sens_839_ad <- sens.slope(summer_standard_dev_all_839_ad$sd_2)
print(summer_sd_sens_839_ad)

```

Winter
```{r 839 SD winter}
winter_standard_dev_all_839_ad <- standard_dev_839_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_839_ad <- winter_standard_dev_all_839_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_839_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_839_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 839 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 839 (corrected)

```{r 839 winter sd mk & ss adjusted}
winter_sd_mk_839_ad <- mk.test(winter_standard_dev_all_839_ad$sd_2)
print(winter_sd_mk_839_ad)

winter_sd_sens_839_ad <- sens.slope(winter_standard_dev_all_839_ad$sd_2)
print(winter_sd_sens_839_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 839 SD spring NOT CORRECTED}
spring_standard_dev_all_839 <- standard_dev_839 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_839 <- spring_standard_dev_all_839 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_839 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_839, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 839 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 839 (non-corrected)

```{r 839 sd spring mk & ss non corrected}

spring_sd_mk_839 <- mk.test(spring_standard_dev_all_839$sd_2)
print(spring_sd_mk_839)

spring_sd_sens_839 <- sens.slope(spring_standard_dev_all_839$sd_2)
print(spring_sd_sens_839)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 839 SD fall NOT CORRECTED}
fall_standard_dev_all_839 <- standard_dev_839 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_839 <- fall_standard_dev_all_839 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_839 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_839, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 839 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 839 (non-corrected)

```{r 839 sd fall mk & ss non corrected}

fall_sd_mk_839 <- mk.test(fall_standard_dev_all_839$sd_2)
print(fall_sd_mk_839)

fall_sd_sens_839 <- sens.slope(fall_standard_dev_all_839$sd_2)
print(fall_sd_sens_839)

```



### Spring and Fall SD CORRECTED

Spring
```{r 839 SD Spring}
spring_standard_dev_all_839_ad <- standard_dev_839_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_839_ad <- spring_standard_dev_all_839_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_839_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_839_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 839 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 839 (corrected)

```{r 839 spring sd mk & ss adjusted}
spring_sd_mk_839_ad <- mk.test(spring_standard_dev_all_839_ad$sd_2)
print(spring_sd_mk_839_ad)

spring_sd_sens_839_ad <- sens.slope(spring_standard_dev_all_839_ad$sd_2)
print(spring_sd_sens_839_ad)

```

Fall
```{r 839 SD fall}
fall_standard_dev_all_839_ad <- standard_dev_839_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_839_ad <- fall_standard_dev_all_839_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_839_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_839_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 839 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 839 (corrected)

```{r 839 fall sd mk & ss adjusted}
fall_sd_mk_839_ad <- mk.test(fall_standard_dev_all_839_ad$sd_2)
print(fall_sd_mk_839_ad)

fall_sd_sens_839_ad <- sens.slope(fall_standard_dev_all_839_ad$sd_2)
print(fall_sd_sens_839_ad)

```



# Upper San Juan	840 
*Morrisey* 4/7/2004

```{r filter (840) station}

snotel_840 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "840")

```

```{r 840 clean & water year & day }
#str(snotel_840) # check the date, usually a character.  

snotel_840$Date <- as.Date(snotel_840$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_840_clean <- snotel_840 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_840_clean <- snotel_840_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 840 plot check }

# Check for outliers

ggplot(snotel_840_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 840 trying to clean outliers}



snotel_840_clean <- snotel_840_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 25)

```


```{r 840 temp difference}

ggplot(snotel_840_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 840 cull selection}

# filtering for temperature anomalies
#snotel_840_cull_count <- snotel_840_clean %>% 
#  filter(temperature_min > -40) %>% 
#  count(waterYear)

#snotel_840_cull_count

# filtering for too few observations in a year
snotel_840_cull_count_days <- snotel_840_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_840_cull_count_days

```

1980, 1981, 1982, 1983, 1984, 1985, 1993, 1994, 2005, 2006, 2013 need to be culled. 

```{r 840 cull}

snotel_840_clean_culled <- snotel_840_clean %>% 
  filter(waterYear >= "1986" & waterYear != "1993" & waterYear != "1994" & waterYear != "2005" & waterYear != "2006" & waterYear != "2013")# & waterYear != "2022") & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_840_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 840 culled plot}

ggplot(snotel_840_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_840_xts <- xts(snotel_840_clean_culled$temperature_mean, order.by = snotel_840_clean_culled$Date)

dygraph(temp_840_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

#snotel_840_clean_culled <- snotel_840_clean_culled %>% 
#  filter(temperature_mean < 19.3)

temp_840_xts <- xts(snotel_840_clean_culled$temperature_mean, order.by = snotel_840_clean_culled$Date)

dygraph(temp_840_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

###  Upper San Juan	840 
*Morrisey* 4/7/2004

```{r 840 adj}

snotel_840_adjusted <- snotel_840_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2004-04-07", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 840 Detrended

```{r 840 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_840 <- snotel_840_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_840 <- yearly_wy_aver_840 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_840 <- daily_wy_aver_840 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_840$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_840 <-daily_wy_aver_840 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_840$date_temp <- signif(daily_wy_aver2_840$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_840, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 840 SD 

```{r 840 SD}

standard_dev_840 <- daily_wy_aver_840 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_840 <- standard_dev_840 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_840 <- standard_dev_all_840 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_840 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_840, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 840 average temperatures for water years 2005-2021* 


#### MK & SS for 840 (non-corrected)

```{r 840 sd mk & ss non corrected}

sd_mk_840 <- mk.test(standard_dev_all_840$sd_2)
print(sd_mk_840)

sd_sens_840 <- sens.slope(standard_dev_all_840$sd_2)
print(sd_sens_840)

```

#### Corrected


#### 840 Detrended (corrected)

```{r 840 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_840_ad <- snotel_840_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_840_ad <- yearly_wy_aver_840_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_840_ad <- daily_wy_aver_840_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_840_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_840_ad <-daily_wy_aver_840_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_840_ad$date_temp_ad <- signif(daily_wy_aver2_840_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_840_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 840 SS (corrected)

```{r 840 SD adjusted}
standard_dev_840_ad <- daily_wy_aver_840_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_840_ad <- standard_dev_840_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_840_ad <- standard_dev_all_840_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_840_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_840_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 840 average temperatures for water years 1986-2021* 


#### MK & SS 840 (corrected)

```{r 840 sd mk & ss adjusted}
sd_mk_840_ad <- mk.test(standard_dev_all_840_ad$sd_2)
print(sd_mk_840_ad)

sd_sens_840_ad <- sens.slope(standard_dev_all_840_ad$sd_2)
print(sd_sens_840_ad)

```



### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 840 SD summer NOT CORRECTED}
summer_standard_dev_all_840 <- standard_dev_840 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_840 <- summer_standard_dev_all_840 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_840 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_840, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 840 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 840 (non-corrected)

```{r 840 sd summer mk & ss non corrected}

summer_sd_mk_840 <- mk.test(summer_standard_dev_all_840$sd_2)
print(summer_sd_mk_840)

summer_sd_sens_840 <- sens.slope(summer_standard_dev_all_840$sd_2)
print(summer_sd_sens_840)

```

Winter
```{r 840 SD winter NOT CORRECTED}
winter_standard_dev_all_840 <- standard_dev_840 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_840 <- winter_standard_dev_all_840 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_840 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_840, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 840 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 840 (non-corrected)

```{r 840 sd winter mk & ss non corrected}

winter_sd_mk_840 <- mk.test(winter_standard_dev_all_840$sd_2)
print(winter_sd_mk_840)

winter_sd_sens_840 <- sens.slope(winter_standard_dev_all_840$sd_2)
print(winter_sd_sens_840)

```



### Summer and Winter SD CORRECTED

Summer
```{r 840 SD Summer}
summer_standard_dev_all_840_ad <- standard_dev_840_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_840_ad <- summer_standard_dev_all_840_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_840_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_840_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 840 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 840 (corrected)

```{r 840 summer sd mk & ss adjusted}
summer_sd_mk_840_ad <- mk.test(summer_standard_dev_all_840_ad$sd_2)
print(summer_sd_mk_840_ad)

summer_sd_sens_840_ad <- sens.slope(summer_standard_dev_all_840_ad$sd_2)
print(summer_sd_sens_840_ad)

```

Winter
```{r 840 SD winter}
winter_standard_dev_all_840_ad <- standard_dev_840_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_840_ad <- winter_standard_dev_all_840_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_840_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_840_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 840 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 840 (corrected)

```{r 840 winter sd mk & ss adjusted}
winter_sd_mk_840_ad <- mk.test(winter_standard_dev_all_840_ad$sd_2)
print(winter_sd_mk_840_ad)

winter_sd_sens_840_ad <- sens.slope(winter_standard_dev_all_840_ad$sd_2)
print(winter_sd_sens_840_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 840 SD spring NOT CORRECTED}
spring_standard_dev_all_840 <- standard_dev_840 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_840 <- spring_standard_dev_all_840 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_840 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_840, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 840 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 840 (non-corrected)

```{r 840 sd spring mk & ss non corrected}

spring_sd_mk_840 <- mk.test(spring_standard_dev_all_840$sd_2)
print(spring_sd_mk_840)

spring_sd_sens_840 <- sens.slope(spring_standard_dev_all_840$sd_2)
print(spring_sd_sens_840)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 840 SD fall NOT CORRECTED}
fall_standard_dev_all_840 <- standard_dev_840 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_840 <- fall_standard_dev_all_840 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_840 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_840, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 840 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 840 (non-corrected)

```{r 840 sd fall mk & ss non corrected}

fall_sd_mk_840 <- mk.test(fall_standard_dev_all_840$sd_2)
print(fall_sd_mk_840)

fall_sd_sens_840 <- sens.slope(fall_standard_dev_all_840$sd_2)
print(fall_sd_sens_840)

```



### Spring and Fall SD CORRECTED

Spring
```{r 840 SD Spring}
spring_standard_dev_all_840_ad <- standard_dev_840_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_840_ad <- spring_standard_dev_all_840_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_840_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_840_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 840 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 840 (corrected)

```{r 840 spring sd mk & ss adjusted}
spring_sd_mk_840_ad <- mk.test(spring_standard_dev_all_840_ad$sd_2)
print(spring_sd_mk_840_ad)

spring_sd_sens_840_ad <- sens.slope(spring_standard_dev_all_840_ad$sd_2)
print(spring_sd_sens_840_ad)

```

Fall
```{r 840 SD fall}
fall_standard_dev_all_840_ad <- standard_dev_840_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_840_ad <- fall_standard_dev_all_840_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_840_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_840_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 840 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 840 (corrected)

```{r 840 fall sd mk & ss adjusted}
fall_sd_mk_840_ad <- mk.test(fall_standard_dev_all_840_ad$sd_2)
print(fall_sd_mk_840_ad)

fall_sd_sens_840_ad <- sens.slope(fall_standard_dev_all_840_ad$sd_2)
print(fall_sd_sens_840_ad)

```



# Vallecito	843 
*Morrisey* 7/22/2005

```{r filter (843) station}

snotel_843 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "843")

```

```{r 843 clean & water year & day }
#str(snotel_843) # check the date, usually a character.  

snotel_843$Date <- as.Date(snotel_843$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_843_clean <- snotel_843 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_843_clean <- snotel_843_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 843 plot check }

# Check for outliers

ggplot(snotel_843_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 843 trying to clean outliers}



snotel_843_clean <- snotel_843_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 25)

```


```{r 843 temp difference}

ggplot(snotel_843_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 843 cull selection}

# filtering for temperature anomalies
#snotel_843_cull_count <- snotel_843_clean %>% 
#  filter(temperature_min > -40) %>% 
#  count(waterYear)

#snotel_843_cull_count

# filtering for too few observations in a year
snotel_843_cull_count_days <- snotel_843_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_843_cull_count_days

```

1994 & 2003 need to be culled. 

```{r 843 cull}

snotel_843_clean_culled <- snotel_843_clean %>% 
  filter(waterYear != "1994" & waterYear != "2003")# & waterYear != "1994" & waterYear != "2005" & waterYear != "2006" & waterYear != "2013")# & waterYear != "2022") & waterYear != "2014") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_843_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 843 culled plot}

ggplot(snotel_843_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_843_xts <- xts(snotel_843_clean_culled$temperature_mean, order.by = snotel_843_clean_culled$Date)

dygraph(temp_843_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

#snotel_843_clean_culled <- snotel_843_clean_culled %>% 
#  filter(temperature_mean < 19.3)

temp_843_xts <- xts(snotel_843_clean_culled$temperature_mean, order.by = snotel_843_clean_culled$Date)

dygraph(temp_843_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

###  Vallecito	843 
*Morrisey* 7/22/2005

```{r 843 adj}

snotel_843_adjusted <- snotel_843_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2005-07-22", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 843 Detrended

```{r 843 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_843 <- snotel_843_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_843 <- yearly_wy_aver_843 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_843 <- daily_wy_aver_843 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_843$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_843 <-daily_wy_aver_843 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_843$date_temp <- signif(daily_wy_aver2_843$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_843, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 843 SD 

```{r 843 SD}

standard_dev_843 <- daily_wy_aver_843 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_843 <- standard_dev_843 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_843 <- standard_dev_all_843 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_843 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_843, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 843 average temperatures for water years 2005-2021* 


#### MK & SS for 843 (non-corrected)

```{r 843 sd mk & ss non corrected}

sd_mk_843 <- mk.test(standard_dev_all_843$sd_2)
print(sd_mk_843)

sd_sens_843 <- sens.slope(standard_dev_all_843$sd_2)
print(sd_sens_843)

```

#### Corrected


#### 843 Detrended (corrected)

```{r 843 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_843_ad <- snotel_843_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_843_ad <- yearly_wy_aver_843_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_843_ad <- daily_wy_aver_843_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_843_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_843_ad <-daily_wy_aver_843_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_843_ad$date_temp_ad <- signif(daily_wy_aver2_843_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_843_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 843 SS (corrected)

```{r 843 SD adjusted}
standard_dev_843_ad <- daily_wy_aver_843_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_843_ad <- standard_dev_843_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_843_ad <- standard_dev_all_843_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_843_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_843_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 843 average temperatures for water years 1986-2021* 


#### MK & SS 843 (corrected)

```{r 843 sd mk & ss adjusted}
sd_mk_843_ad <- mk.test(standard_dev_all_843_ad$sd_2)
print(sd_mk_843_ad)

sd_sens_843_ad <- sens.slope(standard_dev_all_843_ad$sd_2)
print(sd_sens_843_ad)

```



### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 843 SD summer NOT CORRECTED}
summer_standard_dev_all_843 <- standard_dev_843 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_843 <- summer_standard_dev_all_843 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_843 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_843, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 843 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 843 (non-corrected)

```{r 843 sd summer mk & ss non corrected}

summer_sd_mk_843 <- mk.test(summer_standard_dev_all_843$sd_2)
print(summer_sd_mk_843)

summer_sd_sens_843 <- sens.slope(summer_standard_dev_all_843$sd_2)
print(summer_sd_sens_843)

```

Winter
```{r 843 SD winter NOT CORRECTED}
winter_standard_dev_all_843 <- standard_dev_843 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_843 <- winter_standard_dev_all_843 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_843 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_843, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 843 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 843 (non-corrected)

```{r 843 sd winter mk & ss non corrected}

winter_sd_mk_843 <- mk.test(winter_standard_dev_all_843$sd_2)
print(winter_sd_mk_843)

winter_sd_sens_843 <- sens.slope(winter_standard_dev_all_843$sd_2)
print(winter_sd_sens_843)

```



### Summer and Winter SD CORRECTED

Summer
```{r 843 SD Summer}
summer_standard_dev_all_843_ad <- standard_dev_843_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_843_ad <- summer_standard_dev_all_843_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_843_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_843_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 843 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 843 (corrected)

```{r 843 summer sd mk & ss adjusted}
summer_sd_mk_843_ad <- mk.test(summer_standard_dev_all_843_ad$sd_2)
print(summer_sd_mk_843_ad)

summer_sd_sens_843_ad <- sens.slope(summer_standard_dev_all_843_ad$sd_2)
print(summer_sd_sens_843_ad)

```

Winter
```{r 843 SD winter}
winter_standard_dev_all_843_ad <- standard_dev_843_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_843_ad <- winter_standard_dev_all_843_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_843_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_843_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 843 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 843 (corrected)

```{r 843 winter sd mk & ss adjusted}
winter_sd_mk_843_ad <- mk.test(winter_standard_dev_all_843_ad$sd_2)
print(winter_sd_mk_843_ad)

winter_sd_sens_843_ad <- sens.slope(winter_standard_dev_all_843_ad$sd_2)
print(winter_sd_sens_843_ad)

```



### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 843 SD spring NOT CORRECTED}
spring_standard_dev_all_843 <- standard_dev_843 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_843 <- spring_standard_dev_all_843 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_843 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_843, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 843 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 843 (non-corrected)

```{r 843 sd spring mk & ss non corrected}

spring_sd_mk_843 <- mk.test(spring_standard_dev_all_843$sd_2)
print(spring_sd_mk_843)

spring_sd_sens_843 <- sens.slope(spring_standard_dev_all_843$sd_2)
print(spring_sd_sens_843)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 843 SD fall NOT CORRECTED}
fall_standard_dev_all_843 <- standard_dev_843 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_843 <- fall_standard_dev_all_843 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_843 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_843, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 843 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 843 (non-corrected)

```{r 843 sd fall mk & ss non corrected}

fall_sd_mk_843 <- mk.test(fall_standard_dev_all_843$sd_2)
print(fall_sd_mk_843)

fall_sd_sens_843 <- sens.slope(fall_standard_dev_all_843$sd_2)
print(fall_sd_sens_843)

```



### Spring and Fall SD CORRECTED

Spring
```{r 843 SD Spring}
spring_standard_dev_all_843_ad <- standard_dev_843_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_843_ad <- spring_standard_dev_all_843_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_843_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_843_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 843 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 843 (corrected)

```{r 843 spring sd mk & ss adjusted}
spring_sd_mk_843_ad <- mk.test(spring_standard_dev_all_843_ad$sd_2)
print(spring_sd_mk_843_ad)

spring_sd_sens_843_ad <- sens.slope(spring_standard_dev_all_843_ad$sd_2)
print(spring_sd_sens_843_ad)

```

Fall
```{r 843 SD fall}
fall_standard_dev_all_843_ad <- standard_dev_843_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_843_ad <- fall_standard_dev_all_843_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_843_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_843_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 843 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 843 (corrected)

```{r 843 fall sd mk & ss adjusted}
fall_sd_mk_843_ad <- mk.test(fall_standard_dev_all_843_ad$sd_2)
print(fall_sd_mk_843_ad)

fall_sd_sens_843_ad <- sens.slope(fall_standard_dev_all_843_ad$sd_2)
print(fall_sd_sens_843_ad)

```



# Wolf Creek Summit	874 
*Morrisey* 7/12/2004

```{r filter (874) station}

snotel_874 <- SNOTEL_san_juan_Area %>% 
  filter(site_id == "874")

```

```{r 874 clean & water year & day }
#str(snotel_874) # check the date, usually a character.  

snotel_874$Date <- as.Date(snotel_874$date) #change date from character to date format, capitalize to work with Water year functon from NWIS.

#THIS WILL CHANGE FOR EACH STATION
snotel_874_clean <- snotel_874 %>% # filter for the timeframe
  filter(Date >= "1979-10-01" & Date <= "2022-09-30") %>%
  #filter(temperature_mean >= -30 & temperature_mean <= 20) %>% # removing outliers   
  addWaterYear() %>% 
  mutate(daymonth = format(as.Date(Date), "%d-%m")) %>% 
  na.omit()

#adding water day using difftime (SUPER COOL. example from [this](https://stackoverflow.com/questions/48123049/create-day-index-based-on-water-year))

snotel_874_clean <- snotel_874_clean %>% 
  group_by(waterYear)%>% 
  mutate(waterDay = (as.integer(difftime(Date, ymd(paste0(waterYear - 1 ,'-09-30')), units = "days"))))

```


```{r 874 plot check }

# Check for outliers

ggplot(snotel_874_clean, aes(x = Date, y = temperature_mean)) +
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')

```


```{r 874 trying to clean outliers}



snotel_874_clean <- snotel_874_clean %>% 
  mutate(temp_diff = abs(temperature_min - temperature_max)) %>% 
  filter(temperature_mean > -40) %>% 
  filter(temperature_mean < 25)

```


```{r 874 temp difference}

ggplot(snotel_874_clean, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

Per Steven's advice: :If there are more than 15 missing days, then...remove that year"

```{r 874 cull selection}

# filtering for temperature anomalies
#snotel_874_cull_count <- snotel_874_clean %>% 
#  filter(temperature_min > -40) %>% 
#  count(waterYear)

#snotel_874_cull_count

# filtering for too few observations in a year
snotel_874_cull_count_days <- snotel_874_clean %>% 
  group_by(waterYear) %>% 
  count(waterYear) %>% 
  filter(n < 350)

snotel_874_cull_count_days

```

1990, 1994, 2003, 2006, 2007, 2008, 2009, 2010, 2013, 2016, 2017 need to be culled. 

```{r 874 cull}

snotel_874_clean_culled <- snotel_874_clean %>% 
  filter(waterYear != "1990" & waterYear != "1994" & waterYear != "2003" & waterYear != "2006" & waterYear != "2007" & waterYear != "2008" & waterYear != "2009" & waterYear != "2010" & waterYear != "2013" & waterYear != "2016" & waterYear != "2017") #%>% 
  #filter(temperature_mean > -49)

ggplot(snotel_874_clean_culled, aes(x = Date, y = temp_diff)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  #geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature varience (°C)') + 
  xlab('Date')

```

```{r 874 culled plot}

ggplot(snotel_874_clean_culled, aes(x = Date, y = temperature_mean)) + 
  geom_point() + #lwd = 2) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('Daily temperature (°C)') + 
  xlab('Date')


temp_874_xts <- xts(snotel_874_clean_culled$temperature_mean, order.by = snotel_874_clean_culled$Date)

dygraph(temp_874_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 

#snotel_874_clean_culled <- snotel_874_clean_culled %>% 
#  filter(temperature_mean < 19.3)

temp_874_xts <- xts(snotel_874_clean_culled$temperature_mean, order.by = snotel_874_clean_culled$Date)

dygraph(temp_874_xts) %>%
  dyAxis("y", label = "Daily mean temperature (°C)") 


```

###  Wolf Creek Summit	874 
*Morrisey* 7/12/2004

```{r 874 adj}

snotel_874_adjusted <- snotel_874_clean_culled %>%
  mutate(temp_ad = if_else(Date < "2004-07-12", ((5.3*10^(-7))*(temperature_mean^(4))+(3.72*10^(-5))*(temperature_mean^(3))-(2.16*10^(-3))*(temperature_mean^(2))-(7.32*10^(-2))*(temperature_mean)+1.37)+temperature_mean, temperature_mean))

```


Non-corrected

#### 874 Detrended

```{r 874 detrend}

#using the clean culled df:

#average water year temperature

yearly_wy_aver_874 <- snotel_874_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp = mean(temperature_mean))

#Average temperature by day for all water years:

daily_wy_aver_874 <- yearly_wy_aver_874 %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp = mean(temperature_mean))

#average mean temperature by day for the period of record:

daily_wy_aver_874 <- daily_wy_aver_874 %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp = mean(daily_wy_aver_874$aver_day_temp))

# try to show all years as means. 
daily_wy_aver2_874 <-daily_wy_aver_874 %>% 
  group_by(waterDay) %>%
  mutate(date_temp = mean(temperature_mean))
  

daily_wy_aver2_874$date_temp <- signif(daily_wy_aver2_874$date_temp,3) #reduce the sig figs


ggplot(daily_wy_aver2_874, aes(x = waterDay, y = date_temp))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')

```

#### 874 SD 

```{r 874 SD}

standard_dev_874 <- daily_wy_aver_874 %>% 
  group_by(waterYear) %>% 
  mutate(residual = (all_ave_temp-aver_ann_temp)+temperature_mean-aver_day_temp) %>% 
  mutate(deviation = abs(residual-lag(residual)))

standard_dev_all_874 <- standard_dev_874 %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

standard_dev_all_874 <- standard_dev_all_874 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

standard_dev_all_874 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(standard_dev_all_874, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 874 average temperatures for water years 2005-2021* 


#### MK & SS for 874 (non-corrected)

```{r 874 sd mk & ss non corrected}

sd_mk_874 <- mk.test(standard_dev_all_874$sd_2)
print(sd_mk_874)

sd_sens_874 <- sens.slope(standard_dev_all_874$sd_2)
print(sd_sens_874)

```

#### Corrected


#### 874 Detrended (corrected)

```{r 874 detrend adjusted}
#using the clean culled df:
#average water year temperature
yearly_wy_aver_874_ad <- snotel_874_adjusted %>% 
  group_by(waterYear) %>% 
  mutate(aver_ann_temp_ad = mean(temp_ad))
#Average temperature by day for all water years:
daily_wy_aver_874_ad <- yearly_wy_aver_874_ad %>% 
  group_by(daymonth) %>% 
  mutate(aver_day_temp_ad = mean(temp_ad))
#average mean temperature by day for the period of record:
daily_wy_aver_874_ad <- daily_wy_aver_874_ad %>% 
  group_by(daymonth) %>% 
  mutate(all_ave_temp_ad = mean(daily_wy_aver_874_ad$aver_day_temp_ad))
# try to show all years as means. 
daily_wy_aver2_874_ad <-daily_wy_aver_874_ad %>% 
  group_by(waterDay) %>%
  mutate(date_temp_ad = mean(temp_ad))
  
daily_wy_aver2_874_ad$date_temp_ad <- signif(daily_wy_aver2_874_ad$date_temp_ad,3) #reduce the sig figs
ggplot(daily_wy_aver2_874_ad, aes(x = waterDay, y = date_temp_ad))+
  geom_line(size= 0.7) +
  theme_few() +
  ylab('Average Daily temperature (°C)') + 
  xlab('Day of water year')
```

#### 874 SS (corrected)

```{r 874 SD adjusted}
standard_dev_874_ad <- daily_wy_aver_874_ad %>% 
  group_by(waterYear) %>% 
  #filter(waterYear >= 1987 & waterYear <= 2021) %>% 
  mutate(residual = (all_ave_temp_ad-aver_ann_temp_ad)+temp_ad-aver_day_temp_ad) %>% 
  mutate(deviation = abs(residual-lag(residual)))
standard_dev_all_874_ad <- standard_dev_874_ad %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())
standard_dev_all_874_ad <- standard_dev_all_874_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
standard_dev_all_874_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(standard_dev_all_874_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 874 average temperatures for water years 1986-2021* 


#### MK & SS 874 (corrected)

```{r 874 sd mk & ss adjusted}
sd_mk_874_ad <- mk.test(standard_dev_all_874_ad$sd_2)
print(sd_mk_874_ad)

sd_sens_874_ad <- sens.slope(standard_dev_all_874_ad$sd_2)
print(sd_sens_874_ad)

```

*Figure captions are not correct.*


### Summer and Winter SD NOT-CORRECTED

#### Summer
```{r 874 SD summer NOT CORRECTED}
summer_standard_dev_all_874 <- standard_dev_874 %>%
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

summer_standard_dev_all_874 <- summer_standard_dev_all_874 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

summer_standard_dev_all_874 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(summer_standard_dev_all_874, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 874 average summer temperatures for water years 2005-2021* 


#### summer MK & SS for 874 (non-corrected)

```{r 874 sd summer mk & ss non corrected}

summer_sd_mk_874 <- mk.test(summer_standard_dev_all_874$sd_2)
print(summer_sd_mk_874)

summer_sd_sens_874 <- sens.slope(summer_standard_dev_all_874$sd_2)
print(summer_sd_sens_874)

```

Winter
```{r 874 SD winter NOT CORRECTED}
winter_standard_dev_all_874 <- standard_dev_874 %>%
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

winter_standard_dev_all_874 <- winter_standard_dev_all_874 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

winter_standard_dev_all_874 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(winter_standard_dev_all_874, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 874 average winter temperatures for water years 2005-2021* 


#### winter MK & SS for 874 (non-corrected)

```{r 874 sd winter mk & ss non corrected}

winter_sd_mk_874 <- mk.test(winter_standard_dev_all_874$sd_2)
print(winter_sd_mk_874)

winter_sd_sens_874 <- sens.slope(winter_standard_dev_all_874$sd_2)
print(winter_sd_sens_874)

```



### Summer and Winter SD CORRECTED

Summer
```{r 874 SD Summer}
summer_standard_dev_all_874_ad <- standard_dev_874_ad %>% 
  filter(waterDay >= 244 & waterDay <= 335) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
summer_standard_dev_all_874_ad <- summer_standard_dev_all_874_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
summer_standard_dev_all_874_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(summer_standard_dev_all_874_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 874 average summer temperatures for water years 1986-2021* 

#### summer MK & SS 874 (corrected)

```{r 874 summer sd mk & ss adjusted}
summer_sd_mk_874_ad <- mk.test(summer_standard_dev_all_874_ad$sd_2)
print(summer_sd_mk_874_ad)

summer_sd_sens_874_ad <- sens.slope(summer_standard_dev_all_874_ad$sd_2)
print(summer_sd_sens_874_ad)

```

Winter
```{r 874 SD winter}
winter_standard_dev_all_874_ad <- standard_dev_874_ad %>% 
  filter(waterDay >= 32 & waterDay <= 182) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
winter_standard_dev_all_874_ad <- winter_standard_dev_all_874_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
winter_standard_dev_all_874_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(winter_standard_dev_all_874_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 874 average winter temperatures for water years 1986-2021* 

#### winter MK & SS 874 (corrected)

```{r 874 winter sd mk & ss adjusted}
winter_sd_mk_874_ad <- mk.test(winter_standard_dev_all_874_ad$sd_2)
print(winter_sd_mk_874_ad)

winter_sd_sens_874_ad <- sens.slope(winter_standard_dev_all_874_ad$sd_2)
print(winter_sd_sens_874_ad)

```


### Spring and Fall SD NOT-CORRECTED

#### Spring
```{r 874 SD spring NOT CORRECTED}
spring_standard_dev_all_874 <- standard_dev_874 %>%
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())

spring_standard_dev_all_874 <- spring_standard_dev_all_874 %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

spring_standard_dev_all_874 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(spring_standard_dev_all_874, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 874 average spring temperatures for water years 2005-2021* 


#### spring MK & SS for 874 (non-corrected)

```{r 874 sd spring mk & ss non corrected}

spring_sd_mk_874 <- mk.test(spring_standard_dev_all_874$sd_2)
print(spring_sd_mk_874)

spring_sd_sens_874 <- sens.slope(spring_standard_dev_all_874$sd_2)
print(spring_sd_sens_874)

```

Fall

## **Fall is split each water year in the middle of the season. This analysis splits the fall season between the preceding water year and the subsequent water year.**  

```{r 874 SD fall NOT CORRECTED}
fall_standard_dev_all_874 <- standard_dev_874 %>%
  filter(waterDay >= 336 | waterDay <= 31) %>% 
  group_by(waterYear) %>% 
  mutate(nmbr = n())

fall_standard_dev_all_874 <- fall_standard_dev_all_874 %>% 
  #group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)

fall_standard_dev_all_874 %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')

ggplot(fall_standard_dev_all_874, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')

```

*Non-corrected standard deviation of SNOTEL 874 average fall temperatures for water years 2005-2021. Note that the season is split by the water year.* 


#### fall MK & SS for 874 (non-corrected)

```{r 874 sd fall mk & ss non corrected}

fall_sd_mk_874 <- mk.test(fall_standard_dev_all_874$sd_2)
print(fall_sd_mk_874)

fall_sd_sens_874 <- sens.slope(fall_standard_dev_all_874$sd_2)
print(fall_sd_sens_874)

```



### Spring and Fall SD CORRECTED

Spring
```{r 874 SD Spring}
spring_standard_dev_all_874_ad <- standard_dev_874_ad %>% 
  filter(waterDay >= 183 & waterDay <= 243) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
spring_standard_dev_all_874_ad <- spring_standard_dev_all_874_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
spring_standard_dev_all_874_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(spring_standard_dev_all_874_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 874 average spring temperatures for water years 1986-2021* 

#### spring MK & SS 874 (corrected)

```{r 874 spring sd mk & ss adjusted}
spring_sd_mk_874_ad <- mk.test(spring_standard_dev_all_874_ad$sd_2)
print(spring_sd_mk_874_ad)

spring_sd_sens_874_ad <- sens.slope(spring_standard_dev_all_874_ad$sd_2)
print(spring_sd_sens_874_ad)

```

Fall
```{r 874 SD fall}
fall_standard_dev_all_874_ad <- standard_dev_874_ad %>% 
  filter(waterDay >= 336 | waterDay <= 31) %>%
  group_by(waterYear) %>% 
  mutate(nmbr = n())
fall_standard_dev_all_874_ad <- fall_standard_dev_all_874_ad %>% 
  group_by(waterYear) %>% 
  mutate(resid_mean = mean(residual)) %>%
  mutate(sd_1 = residual-resid_mean) %>% 
  mutate(sd_2 = (((sum((sd_1)^2))/((nmbr-1))))^(0.5)) %>%
  distinct(sd_2, .keep_all = TRUE) %>% 
   select(waterYear, sd_2)
fall_standard_dev_all_874_ad %>% 
  kable(.,'html') %>%
  kable_styling() %>%
  scroll_box(width='250px',height='500px')
ggplot(fall_standard_dev_all_874_ad, aes(x = waterYear, y = sd_2))+
  geom_line(size= 0.7) +
  theme_few() +
  geom_smooth(method = "lm", se=FALSE) +
  ylab('SD') + 
  xlab('Water year')
```

*Morrisey-corrected standard deviation of SNOTEL 874 average fall temperatures for water years 1986-2021. Note that the fall season is split by the water year.* 

#### fall MK & SS 874 (corrected)

```{r 874 fall sd mk & ss adjusted}
fall_sd_mk_874_ad <- mk.test(fall_standard_dev_all_874_ad$sd_2)
print(fall_sd_mk_874_ad)

fall_sd_sens_874_ad <- sens.slope(fall_standard_dev_all_874_ad$sd_2)
print(fall_sd_sens_874_ad)

```



(getting git workflow errors...)